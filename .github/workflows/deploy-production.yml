name: Deploy to Production

on:
  push:
    tags:
      - 'v*'  # 匹配 v1.0.0, v2.1.3 等

env:
  NODE_VERSION: 20
  PNPM_VERSION: 10
  # ⚠️ 1Panel 部署路径配置 - 请根据实际域名修改
  SITE_DOMAIN: www.thepexels.art  # 替换为你的实际域名
  PANEL_BASE_PATH: /opt/1panel/apps/openresty/openresty/www/sites

jobs:
  quality-check:
    name: 代码质量检查
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: 安装依赖
        run: pnpm install --frozen-lockfile

      - name: Lint 检查
        run: pnpm lint

      - name: TypeScript 类型检查 - Web
        run: pnpm -C apps/web tsc --noEmit

      - name: TypeScript 类型检查 - Admin
        run: pnpm -C apps/admin tsc --noEmit

      - name: TypeScript 类型检查 - Backend
        run: pnpm -C apps/backend tsc --noEmit

      - name: Backend 单元测试
        run: pnpm -C apps/backend test

  build-and-deploy:
    name: 构建并部署
    needs: quality-check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: 安装依赖
        run: pnpm install --frozen-lockfile

      # ========== Backend 构建与部署 ==========

      - name: 构建 Backend Docker 镜像
        working-directory: apps/backend
        run: |
          docker build -t snapmatch-backend:${{ github.ref_name }} .
          docker tag snapmatch-backend:${{ github.ref_name }} snapmatch-backend:latest

      - name: 保存 Docker 镜像
        run: |
          docker save snapmatch-backend:latest | gzip > backend-image.tar.gz

      - name: 部署 Backend 到服务器
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "backend-image.tar.gz"
          target: "/tmp/"

      - name: 在服务器上启动 Backend 容器
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            # 加载 Docker 镜像
            docker load < /tmp/backend-image.tar.gz
            rm /tmp/backend-image.tar.gz

            # 停止旧容器
            docker stop snapmatch-backend || true
            docker rm snapmatch-backend || true

            # 启动新容器
            docker run -d \
              --name snapmatch-backend \
              --restart unless-stopped \
              -p 3002:3000 \
              --env-file /opt/1panel/apps/snapmatch/backend/.env.production \
              snapmatch-backend:latest

            # 等待健康检查
            echo "等待 Backend 启动..."
            for i in {1..30}; do
              if curl -f http://localhost:3002/health; then
                echo "✅ Backend 健康检查通过"
                exit 0
              fi
              echo "尝试 $i/30..."
              sleep 2
            done
            echo "❌ Backend 健康检查失败"
            exit 1

      # ========== 前端构建与部署 ==========

      - name: 构建 Web 前端
        run: pnpm -C apps/web build
        env:
          NEXT_PUBLIC_ADMIN_BASE_URL: https://www.thepexels.art/admin  # 替换为实际域名

      - name: 构建 Admin 后台
        run: pnpm -C apps/admin build
        env:
          NEXT_PUBLIC_API_BASE_URL: https://www.thepexels.art/api  # 替换为实际域名

      - name: 部署 Web 到服务器
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "apps/web/out/*"
          target: "${{ env.PANEL_BASE_PATH }}/${{ env.SITE_DOMAIN }}/"
          strip_components: 3  # 去掉 apps/web/out 前缀
          rm: true  # 清除旧文件

      - name: 部署 Admin 到服务器
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "apps/admin/out/*"
          target: "${{ env.PANEL_BASE_PATH }}/${{ env.SITE_DOMAIN }}/admin/"
          strip_components: 3
          rm: true

      - name: 重启 Nginx (清除缓存)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            sudo systemctl reload nginx
            echo "✅ Nginx 已重启"

  notify:
    name: 部署通知
    needs: build-and-deploy
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: 发送通知
        run: |
          echo "部署状态: ${{ needs.build-and-deploy.result }}"
          echo "Tag: ${{ github.ref_name }}"
          echo "提交: ${{ github.sha }}"
          # TODO: 可以添加 Slack/钉钉通知
