name: Deploy to Production

on:
  push:
    tags:
      - 'v*' # 匹配 v1.0.0, v2.1.3 等

env:
  NODE_VERSION: 20
  PNPM_VERSION: 10
  # ✅ 使用 GitHub Secrets 配置部署路径，支持灵活切换域名/IP
  # 在 GitHub Settings → Secrets → 添加 SITE_DOMAIN 和 API_BASE_URL
  SITE_DOMAIN: ${{ secrets.SITE_DOMAIN || 'www.thepexels.art' }}
  PANEL_BASE_PATH: /opt/1panel/apps/openresty/openresty/www/sites

jobs:
  quality-check:
    name: 代码质量检查
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: 安装依赖
        run: pnpm install --frozen-lockfile

      - name: Lint 检查 - Admin
        run: pnpm -C apps/admin lint

      - name: Lint 检查 - Backend
        run: pnpm -C apps/backend lint

      - name: Lint 检查 - Web
        run: pnpm -C apps/web lint

      - name: TypeScript 类型检查 - Web
        run: pnpm -C apps/web type-check

      - name: TypeScript 类型检查 - Admin
        run: pnpm -C apps/admin type-check

      - name: TypeScript 类型检查 - Backend
        run: pnpm -C apps/backend type-check

      - name: Backend 单元测试
        run: pnpm -C apps/backend test

  deploy-backend:
    name: 部署 Backend
    needs: quality-check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: 安装依赖
        run: pnpm install --frozen-lockfile

      # ========== Backend 构建与部署 ==========
      # 改进：直接在服务器上构建，避免传输大镜像

      - name: 在服务器上构建并启动 Backend
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e

            # 使用 root 权限执行所有操作
            sudo bash << 'ENDSCRIPT'
            set -e

            # 进入项目目录
            cd /opt/1panel/apps/snapmatch || mkdir -p /opt/1panel/apps/snapmatch && cd /opt/1panel/apps/snapmatch

            # 拉取最新代码
            echo "→ 拉取最新代码..."
            if [ -d "snapmatch-platform" ]; then
              cd snapmatch-platform
              git fetch --all
              git checkout ${{ github.sha }}
            else
              git clone https://github.com/ylc6223/snapmatch-platform.git
              cd snapmatch-platform
              git checkout ${{ github.sha }}
            fi

            # 检查环境变量文件
            if [ ! -f /opt/1panel/apps/snapmatch/backend/.env.production ]; then
              echo "⚠️ 警告: .env.production 文件不存在"
              echo "请参考文档创建环境变量文件"
              exit 1
            fi

            # 进入 backend 目录
            cd apps/backend

            # 停止旧容器
            echo "→ 停止旧容器..."
            docker stop snapmatch-backend 2>/dev/null || true
            docker rm snapmatch-backend 2>/dev/null || true

            # 在服务器上构建镜像（不传输！）
            echo "→ 在服务器上构建镜像..."
            docker build -t snapmatch-backend:${{ github.ref_name }} .
            docker tag snapmatch-backend:${{ github.ref_name }} snapmatch-backend:latest

            # 启动新容器
            echo "→ 启动新容器..."
            docker run -d \
              --name snapmatch-backend \
              --restart unless-stopped \
              -p 3002:3000 \
              --env-file /opt/1panel/apps/snapmatch/backend/.env.production \
              -e PORT=3000 \
              -e NODE_ENV=production \
              snapmatch-backend:latest

            # 清理旧镜像
            echo "→ 清理旧镜像..."
            docker image prune -a --filter "until=24h" -f

            # 等待健康检查
            echo "等待 Backend 启动..."
            for i in {1..30}; do
              if curl -f http://localhost:3002/health; then
                echo "✅ Backend 健康检查通过"
                exit 0
              fi
              echo "尝试 $i/30..."
              sleep 2
            done
            echo "❌ Backend 健康检查失败"
            echo "查看容器日志:"
            docker logs snapmatch-backend
            exit 1
            ENDSCRIPT

  deploy-web:
    name: 部署 Web 官网
    needs: quality-check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: 安装依赖
        run: pnpm install --frozen-lockfile

      - name: 缓存 Web 构建缓存（Next.js）
        uses: actions/cache@v4
        with:
          path: apps/web/.next/cache
          key: ${{ runner.os }}-next-web-${{ hashFiles('pnpm-lock.yaml', 'apps/web/pnpm-lock.yaml', 'apps/web/package.json') }}
          restore-keys: |
            ${{ runner.os }}-next-web-

      - name: 构建 Web 前端
        run: pnpm -C apps/web build
        # 不在构建时写死域名，默认使用相对路径 /admin（本地开发会自动指向 localhost:3001/admin）

      - name: 准备服务器目录
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            # 1Panel + OpenResty 默认站点根目录为：/www/sites/<domain>/index（容器内路径）
            # 对应宿主机目录通常为：${{ env.PANEL_BASE_PATH }}/${{ env.SITE_DOMAIN }}/index
            WEB_ROOT_DIR="${{ env.PANEL_BASE_PATH }}/${{ env.SITE_DOMAIN }}/index"

            # 创建 Web 根目录并设置临时写入权限
            sudo mkdir -p "$WEB_ROOT_DIR"
            sudo chown -R ${{ secrets.SERVER_USER }}:${{ secrets.SERVER_USER }} "$WEB_ROOT_DIR"

      - name: 准备 SSH（rsync）
        shell: bash
        run: |
          set -euo pipefail

          if ! command -v rsync >/dev/null 2>&1; then
            echo "❌ 未检测到 rsync（runner 环境异常），无法继续部署。"
            exit 1
          fi

          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          (umask 077 && printf '%s\n' "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_ed25519)
          chmod 600 ~/.ssh/id_ed25519

          ssh-keyscan -H "${{ secrets.SERVER_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null
          ssh-keygen -F "${{ secrets.SERVER_HOST }}" >/dev/null 2>&1 || {
            echo "❌ 未能写入 known_hosts，终止部署。"
            exit 1
          }

      - name: 部署 Web 文件到服务器（rsync）
        shell: bash
        run: |
          set -euo pipefail
          WEB_ROOT_DIR="${{ env.PANEL_BASE_PATH }}/${{ env.SITE_DOMAIN }}/index"

          rsync -az --delete --info=progress2 --partial \
            -e "ssh -i ~/.ssh/id_ed25519 -o BatchMode=yes -o StrictHostKeyChecking=yes -o ConnectTimeout=120 -o ServerAliveInterval=15 -o ServerAliveCountMax=8" \
            apps/web/out/ \
            "${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${WEB_ROOT_DIR}/"

      - name: 设置 Web 文件权限
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            WEB_ROOT_DIR="${{ env.PANEL_BASE_PATH }}/${{ env.SITE_DOMAIN }}/index"
            sudo chown -R www-data:www-data "$WEB_ROOT_DIR"
            sudo chmod -R 755 "$WEB_ROOT_DIR"

  deploy-admin:
    name: 部署 Admin 后台
    needs: quality-check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: 安装依赖
        run: pnpm install --frozen-lockfile

      - name: 缓存 Admin 构建缓存（Next.js）
        uses: actions/cache@v4
        with:
          path: apps/admin/.next/cache
          key: ${{ runner.os }}-next-admin-${{ hashFiles('pnpm-lock.yaml', 'apps/admin/pnpm-lock.yaml', 'apps/admin/package.json') }}
          restore-keys: |
            ${{ runner.os }}-next-admin-

      - name: 构建 Admin (Standalone 模式)
        run: pnpm -C apps/admin build
        env:
          NEXT_PUBLIC_API_BASE_URL: ${{ secrets.API_BASE_URL || 'https://www.thepexels.art/api' }}

      - name: 打包 Standalone 文件
        run: |
          # 复制必要的文件到 standalone 目录（Next Standalone 默认不包含 static 与 public）
          cp -r apps/admin/.next/static apps/admin/.next/standalone/apps/admin/.next/
          cp -r apps/admin/public apps/admin/.next/standalone/apps/admin/

          # 打包到仓库根目录，供 rsync 上传
          tar -czf admin-standalone.tar.gz -C apps/admin/.next/standalone .

          # 兜底检查：确保归档非空，并输出大小（排查上传卡住时很关键）
          ls -lah admin-standalone.tar.gz
          du -h admin-standalone.tar.gz

      - name: 准备 SSH（rsync）
        shell: bash
        run: |
          set -euo pipefail

          if ! command -v rsync >/dev/null 2>&1; then
            echo "❌ 未检测到 rsync（runner 环境异常），无法继续部署。"
            exit 1
          fi

          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          (umask 077 && printf '%s\n' "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_ed25519)
          chmod 600 ~/.ssh/id_ed25519

          ssh-keyscan -H "${{ secrets.SERVER_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null
          ssh-keygen -F "${{ secrets.SERVER_HOST }}" >/dev/null 2>&1 || {
            echo "❌ 未能写入 known_hosts，终止部署。"
            exit 1
          }

      - name: 上传 Admin 到服务器（rsync）
        shell: bash
        run: |
          set -euo pipefail
          ls -lah admin-standalone.tar.gz

          rsync -az --info=progress2 --partial \
            -e "ssh -i ~/.ssh/id_ed25519 -o BatchMode=yes -o StrictHostKeyChecking=yes -o ConnectTimeout=120 -o ServerAliveInterval=15 -o ServerAliveCountMax=8" \
            admin-standalone.tar.gz \
            "${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/admin-standalone.tar.gz"

      - name: 校验 Admin 包已上传到服务器
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -euo pipefail
            if [ ! -f /tmp/admin-standalone.tar.gz ]; then
              echo "❌ /tmp/admin-standalone.tar.gz 不存在（上传失败），终止部署。"
              exit 1
            fi
            ls -lah /tmp/admin-standalone.tar.gz

      - name: 部署 Admin 服务
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -euo pipefail

            # 重要：当前服务器的 Node/PM2 安装在 root 的 nvm 目录（/root/.nvm），
            # GitHub Actions 通过 ${{ secrets.SERVER_USER }}（通常是 ubuntu）登录时默认找不到 node/pm2。
            # 因此所有 PM2 操作统一用 sudo + login shell 执行，并显式加载 root 的 nvm 环境。
            run_as_root() {
              sudo bash -lc "export NVM_DIR=/root/.nvm; [ -s \"\$NVM_DIR/nvm.sh\" ] && . \"\$NVM_DIR/nvm.sh\"; $*"
            }

            if ! run_as_root "command -v node >/dev/null 2>&1"; then
              echo "❌ root 环境未检测到 Node.js（nvm），请先为 root 安装 Node.js 20+ 或修复 /root/.nvm。"
              exit 1
            fi

            if ! run_as_root "command -v pm2 >/dev/null 2>&1"; then
              echo "⚠️ root 环境未检测到 pm2，尝试安装..."
              run_as_root "npm i -g pm2"
              if ! run_as_root "command -v pm2 >/dev/null 2>&1"; then
                echo "❌ pm2 安装后仍不可用，请检查 root 的 nvm/npm 全局 bin。"
                exit 1
              fi
            fi

            # 创建 Admin 应用目录
            mkdir -p /opt/1panel/apps/snapmatch/admin
            cd /opt/1panel/apps/snapmatch/admin

            # 解压新文件
            tar -xzf /tmp/admin-standalone.tar.gz
            rm /tmp/admin-standalone.tar.gz

            # 创建 PM2 配置文件（如果不存在）
            if [ ! -f ecosystem.config.js ]; then
              cat > ecosystem.config.js << 'EOFPM2'
            module.exports = {
              apps: [{
                name: 'snapmatch-admin',
                script: 'apps/admin/server.js',
                cwd: '/opt/1panel/apps/snapmatch/admin',
                instances: 1,
                exec_mode: 'cluster',
                env: {
                  NODE_ENV: 'production',
                  PORT: 3001,
                  HOSTNAME: '0.0.0.0',
                },
                error_file: '/opt/1panel/apps/snapmatch/admin/logs/error.log',
                out_file: '/opt/1panel/apps/snapmatch/admin/logs/out.log',
                log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
              }]
            };
            EOFPM2
            fi

            # 创建日志目录
            mkdir -p logs

            # 使用 PM2 启动或重启服务
            if run_as_root "pm2 describe snapmatch-admin >/dev/null 2>&1"; then
              echo "重启 Admin 服务..."
              run_as_root "pm2 restart snapmatch-admin"
            else
              echo "首次启动 Admin 服务..."
              run_as_root "pm2 start ecosystem.config.js"
              run_as_root "pm2 save"
            fi

            # 等待服务启动
            sleep 3

            # 检查服务状态
            run_as_root "pm2 status snapmatch-admin"

            # 验证服务是否可访问
            if curl -f http://localhost:3001/admin/ > /dev/null 2>&1; then
              echo "✅ Admin 服务启动成功"
            else
              echo "❌ Admin 服务启动失败，查看日志:"
              run_as_root "pm2 logs snapmatch-admin --lines 50 --nostream"
              exit 1
            fi

  notify:
    name: 部署通知
    needs: [deploy-backend, deploy-web, deploy-admin]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: 发送通知
        run: |
          echo "Backend 部署状态: ${{ needs.deploy-backend.result }}"
          echo "Web 部署状态: ${{ needs.deploy-web.result }}"
          echo "Admin 部署状态: ${{ needs.deploy-admin.result }}"
          echo "Tag: ${{ github.ref_name }}"
          echo "提交: ${{ github.sha }}"
          # TODO: 可以添加 Slack/钉钉通知
