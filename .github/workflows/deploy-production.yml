name: Deploy to Production

on:
  push:
    tags:
      - 'v*' # 匹配 v1.0.0, v2.1.3 等

env:
  NODE_VERSION: 20
  PNPM_VERSION: 10
  # ⚠️ 1Panel 部署路径配置 - 请根据实际域名修改
  SITE_DOMAIN: www.thepexels.art # 替换为你的实际域名
  PANEL_BASE_PATH: /opt/1panel/apps/openresty/openresty/www/sites

jobs:
  quality-check:
    name: 代码质量检查
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: 安装依赖
        run: pnpm install --frozen-lockfile

      - name: Lint 检查 - Admin
        run: pnpm -C apps/admin lint

      - name: Lint 检查 - Backend
        run: pnpm -C apps/backend lint

      - name: Lint 检查 - Web
        run: pnpm -C apps/web lint

      - name: TypeScript 类型检查 - Web
        run: pnpm -C apps/web type-check

      - name: TypeScript 类型检查 - Admin
        run: pnpm -C apps/admin type-check

      - name: TypeScript 类型检查 - Backend
        run: pnpm -C apps/backend type-check

      - name: Backend 单元测试
        run: pnpm -C apps/backend test

  deploy-backend:
    name: 部署 Backend
    needs: quality-check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: 安装依赖
        run: pnpm install --frozen-lockfile

      # ========== Backend 构建与部署 ==========

      - name: 构建 Backend Docker 镜像
        working-directory: apps/backend
        run: |
          docker build -t snapmatch-backend:${{ github.ref_name }} .
          docker tag snapmatch-backend:${{ github.ref_name }} snapmatch-backend:latest

      - name: 保存 Docker 镜像
        run: |
          docker save snapmatch-backend:latest | gzip > backend-image.tar.gz

      - name: 部署 Backend Docker 镜像到服务器
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: 'backend-image.tar.gz'
          target: '/tmp/'

      - name: 在服务器上启动 Backend 容器
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            # 创建配置目录
            sudo mkdir -p /opt/1panel/apps/snapmatch/backend

            # 检查 .env.production 是否存在，如果不存在则提示用户创建
            if [ ! -f /opt/1panel/apps/snapmatch/backend/.env.production ]; then
              echo "⚠️ 警告: .env.production 文件不存在"
              echo "请参考文档创建环境变量文件:"
              echo "  1. 基于 apps/backend/.env.example 创建 .env.production"
              echo "  2. 填写必要的配置项 (JWT_SECRET, CLOUDBASE_ENV, CLOUDBASE_SECRET_ID, CLOUDBASE_SECRET_KEY)"
              echo "  3. 上传到服务器路径: /opt/1panel/apps/snapmatch/backend/.env.production"
              echo ""
              echo "❌ 部署终止: 缺少环境变量文件"
              exit 1
            fi

            # 加载 Docker 镜像
            sudo docker load < /tmp/backend-image.tar.gz
            rm /tmp/backend-image.tar.gz

            # 停止旧容器
            sudo docker stop snapmatch-backend || true
            sudo docker rm snapmatch-backend || true

            # 启动新容器
            sudo docker run -d \
              --name snapmatch-backend \
              --restart unless-stopped \
              -p 3002:3000 \
              --env-file /opt/1panel/apps/snapmatch/backend/.env.production \
              snapmatch-backend:latest

            # 等待健康检查
            echo "等待 Backend 启动..."
            for i in {1..30}; do
              if curl -f http://localhost:3002/health; then
                echo "✅ Backend 健康检查通过"
                exit 0
              fi
              echo "尝试 $i/30..."
              sleep 2
            done
            echo "❌ Backend 健康检查失败"
            echo "查看容器日志:"
            sudo docker logs snapmatch-backend
            exit 1

  deploy-web:
    name: 部署 Web 官网
    needs: quality-check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: 安装依赖
        run: pnpm install --frozen-lockfile

      - name: 构建 Web 前端
        run: pnpm -C apps/web build
        env:
          NEXT_PUBLIC_ADMIN_BASE_URL: https://www.thepexels.art/admin

      - name: 准备服务器目录
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            # 1Panel + OpenResty 默认站点根目录为：/www/sites/<domain>/index（容器内路径）
            # 对应宿主机目录通常为：${{ env.PANEL_BASE_PATH }}/${{ env.SITE_DOMAIN }}/index
            WEB_ROOT_DIR="${{ env.PANEL_BASE_PATH }}/${{ env.SITE_DOMAIN }}/index"

            # 创建 Web 根目录并设置临时写入权限
            sudo mkdir -p "$WEB_ROOT_DIR"
            sudo chown -R ${{ secrets.SERVER_USER }}:${{ secrets.SERVER_USER }} "$WEB_ROOT_DIR"

            # 仅清理 Web 根目录内容（不动站点其他目录：admin/log/rewrite/proxy 等）
            cd "$WEB_ROOT_DIR"
            find . -mindepth 1 -maxdepth 1 -exec rm -rf {} +

      - name: 部署 Web 文件到服务器
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: 'apps/web/out/*'
          target: '${{ env.PANEL_BASE_PATH }}/${{ env.SITE_DOMAIN }}/index/'
          strip_components: 3

      - name: 设置 Web 文件权限
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            WEB_ROOT_DIR="${{ env.PANEL_BASE_PATH }}/${{ env.SITE_DOMAIN }}/index"
            sudo chown -R www-data:www-data "$WEB_ROOT_DIR"
            sudo chmod -R 755 "$WEB_ROOT_DIR"

  deploy-admin:
    name: 部署 Admin 后台
    needs: quality-check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: 安装依赖
        run: pnpm install --frozen-lockfile

      - name: 构建 Admin (Standalone 模式)
        run: pnpm -C apps/admin build
        env:
          NEXT_PUBLIC_API_BASE_URL: https://www.thepexels.art/api

      - name: 打包 Standalone 文件
        run: |
          # 说明：scp-action 运行在独立容器中，只会挂载 /github/workspace，
          # 因此不能把要上传的文件打到 runner 的 /tmp 下，否则 scp-action 会找不到源文件并报 tar: empty archive。
          #
          # 复制必要的文件到 standalone 目录（Next Standalone 默认不包含 static 与 public）
          cp -r apps/admin/.next/static apps/admin/.next/standalone/apps/admin/.next/
          cp -r apps/admin/public apps/admin/.next/standalone/apps/admin/

          # 打包到仓库根目录，供 scp-action 读取
          tar -czf admin-standalone.tar.gz -C apps/admin/.next/standalone .

          # 兜底检查：确保归档非空，并输出大小（排查 scp 卡住时很关键）
          ls -lah admin-standalone.tar.gz
          du -h admin-standalone.tar.gz

      - name: 上传 Admin 到服务器
        uses: appleboy/scp-action@v0.1.7
        continue-on-error: true
        timeout-minutes: 6
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: 'admin-standalone.tar.gz'
          target: '/tmp/'
          timeout: 120s
          # scp-action 在部分网络/服务器配置下可能长时间无输出；先缩短超时，失败后走备用上传方案
          command_timeout: 5m
          debug: true

      - name: 上传 Admin 到服务器（备用：OpenSSH scp）
        if: ${{ failure() }}
        timeout-minutes: 10
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # 写入私钥（避免回显）
          (umask 077 && printf '%s\n' "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_ed25519)
          chmod 600 ~/.ssh/id_ed25519

          # 预写 known_hosts，避免 StrictHostKeyChecking 交互阻塞
          ssh-keyscan -H "${{ secrets.SERVER_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null || true

          # 通过 ServerAlive 防止“连接已死但不报错”的长时间挂起
          scp \
            -v \
            # OpenSSH 新版 scp 默认走 SFTP；某些服务器 SFTP 子系统配置异常会导致卡住
            # 这里强制使用 legacy scp 协议（不引入新依赖）
            -O \
            -o BatchMode=yes \
            -o ConnectTimeout=120 \
            -o ServerAliveInterval=15 \
            -o ServerAliveCountMax=8 \
            -i ~/.ssh/id_ed25519 \
            -C \
            admin-standalone.tar.gz \
            "${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/admin-standalone.tar.gz"

      - name: 部署 Admin 服务
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -euo pipefail

            # Admin Standalone 需要 Node.js 运行时；进程托管使用 PM2
            if ! command -v node >/dev/null 2>&1; then
              echo "❌ 未检测到 Node.js，请先在服务器安装 Node.js (建议 20+)，再重新部署。"
              exit 1
            fi

            # 兼容：若 Node 通过 nvm 安装，非交互 shell 可能缺少全局 bin PATH
            if command -v npm >/dev/null 2>&1; then
              export PATH="$(npm bin -g 2>/dev/null || true):$PATH"
            fi

            if ! command -v pm2 >/dev/null 2>&1; then
              echo "⚠️ pm2 未安装，尝试安装..."
              if ! command -v npm >/dev/null 2>&1; then
                echo "❌ 未检测到 npm，无法自动安装 pm2。"
                exit 1
              fi

              npm i -g pm2 >/dev/null 2>&1 || sudo npm i -g pm2
              export PATH="$(npm bin -g 2>/dev/null || true):$PATH"

              if ! command -v pm2 >/dev/null 2>&1; then
                echo "❌ pm2 安装后仍不可用，请检查服务器 PATH 或改为系统级安装。"
                echo "npm bin -g: $(npm bin -g 2>/dev/null || echo '<unknown>')"
                exit 1
              fi
            fi

            # 创建 Admin 应用目录
            mkdir -p /opt/1panel/apps/snapmatch/admin
            cd /opt/1panel/apps/snapmatch/admin

            # 解压新文件
            tar -xzf /tmp/admin-standalone.tar.gz
            rm /tmp/admin-standalone.tar.gz

            # 创建 PM2 配置文件（如果不存在）
            if [ ! -f ecosystem.config.js ]; then
              cat > ecosystem.config.js << 'EOFPM2'
            module.exports = {
              apps: [{
                name: 'snapmatch-admin',
                script: 'apps/admin/server.js',
                cwd: '/opt/1panel/apps/snapmatch/admin',
                instances: 1,
                exec_mode: 'cluster',
                env: {
                  NODE_ENV: 'production',
                  PORT: 3001,
                  HOSTNAME: '0.0.0.0',
                },
                error_file: '/opt/1panel/apps/snapmatch/admin/logs/error.log',
                out_file: '/opt/1panel/apps/snapmatch/admin/logs/out.log',
                log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
              }]
            };
            EOFPM2
            fi

            # 创建日志目录
            mkdir -p logs

            # 使用 PM2 启动或重启服务
            if pm2 describe snapmatch-admin > /dev/null 2>&1; then
              echo "重启 Admin 服务..."
              pm2 restart snapmatch-admin
            else
              echo "首次启动 Admin 服务..."
              pm2 start ecosystem.config.js
              pm2 save
            fi

            # 等待服务启动
            sleep 3

            # 检查服务状态
            pm2 status snapmatch-admin

            # 验证服务是否可访问
            if curl -f http://localhost:3001/admin/ > /dev/null 2>&1; then
              echo "✅ Admin 服务启动成功"
            else
              echo "❌ Admin 服务启动失败，查看日志:"
              pm2 logs snapmatch-admin --lines 50 --nostream
              exit 1
            fi

  notify:
    name: 部署通知
    needs: [deploy-backend, deploy-web, deploy-admin]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: 发送通知
        run: |
          echo "Backend 部署状态: ${{ needs.deploy-backend.result }}"
          echo "Web 部署状态: ${{ needs.deploy-web.result }}"
          echo "Admin 部署状态: ${{ needs.deploy-admin.result }}"
          echo "Tag: ${{ github.ref_name }}"
          echo "提交: ${{ github.sha }}"
          # TODO: 可以添加 Slack/钉钉通知
