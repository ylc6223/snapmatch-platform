name: Deploy to Production

on:
  push:
    tags:
      - 'v*' # 匹配 v1.0.0, v2.1.3 等

env:
  NODE_VERSION: 20
  PNPM_VERSION: 10
  # ⚠️ 1Panel 部署路径配置 - 请根据实际域名修改
  SITE_DOMAIN: www.thepexels.art # 替换为你的实际域名
  PANEL_BASE_PATH: /opt/1panel/apps/openresty/openresty/www/sites

jobs:
  quality-check:
    name: 代码质量检查
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: 安装依赖
        run: pnpm install --frozen-lockfile

      - name: Lint 检查 - Admin
        run: pnpm -C apps/admin lint

      - name: Lint 检查 - Backend
        run: pnpm -C apps/backend lint

      - name: Lint 检查 - Web
        run: pnpm -C apps/web lint

      - name: TypeScript 类型检查 - Web
        run: pnpm -C apps/web type-check

      - name: TypeScript 类型检查 - Admin
        run: pnpm -C apps/admin type-check

      - name: TypeScript 类型检查 - Backend
        run: pnpm -C apps/backend type-check

      - name: Backend 单元测试
        run: pnpm -C apps/backend test

  deploy-backend:
    name: 部署 Backend
    needs: quality-check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: 安装依赖
        run: pnpm install --frozen-lockfile

      # ========== Backend 构建与部署 ==========

      - name: 构建 Backend Docker 镜像
        working-directory: apps/backend
        run: |
          docker build -t snapmatch-backend:${{ github.ref_name }} .
          docker tag snapmatch-backend:${{ github.ref_name }} snapmatch-backend:latest

      - name: 保存 Docker 镜像
        run: |
          docker save snapmatch-backend:latest | gzip > backend-image.tar.gz

      - name: 部署 Backend Docker 镜像到服务器
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: 'backend-image.tar.gz'
          target: '/tmp/'

      - name: 在服务器上启动 Backend 容器
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            # 创建配置目录
            sudo mkdir -p /opt/1panel/apps/snapmatch/backend

            # 检查 .env.production 是否存在，如果不存在则提示用户创建
            if [ ! -f /opt/1panel/apps/snapmatch/backend/.env.production ]; then
              echo "⚠️ 警告: .env.production 文件不存在"
              echo "请参考文档创建环境变量文件:"
              echo "  1. 基于 apps/backend/.env.example 创建 .env.production"
              echo "  2. 填写必要的配置项 (JWT_SECRET, CLOUDBASE_ENV, CLOUDBASE_SECRET_ID, CLOUDBASE_SECRET_KEY)"
              echo "  3. 上传到服务器路径: /opt/1panel/apps/snapmatch/backend/.env.production"
              echo ""
              echo "❌ 部署终止: 缺少环境变量文件"
              exit 1
            fi

            # 加载 Docker 镜像
            sudo docker load < /tmp/backend-image.tar.gz
            rm /tmp/backend-image.tar.gz

            # 停止旧容器
            sudo docker stop snapmatch-backend || true
            sudo docker rm snapmatch-backend || true

            # 启动新容器
            sudo docker run -d \
              --name snapmatch-backend \
              --restart unless-stopped \
              -p 3002:3000 \
              --env-file /opt/1panel/apps/snapmatch/backend/.env.production \
              snapmatch-backend:latest

            # 等待健康检查
            echo "等待 Backend 启动..."
            for i in {1..30}; do
              if curl -f http://localhost:3002/health; then
                echo "✅ Backend 健康检查通过"
                exit 0
              fi
              echo "尝试 $i/30..."
              sleep 2
            done
            echo "❌ Backend 健康检查失败"
            echo "查看容器日志:"
            sudo docker logs snapmatch-backend
            exit 1

  deploy-frontend:
    name: 部署前端
    needs: quality-check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: 安装依赖
        run: pnpm install --frozen-lockfile

      # ========== 前端构建与部署 ==========

      - name: 构建 Web 前端
        run: pnpm -C apps/web build
        env:
          NEXT_PUBLIC_ADMIN_BASE_URL: https://www.thepexels.art/admin # 替换为实际域名

      - name: 构建 Admin 后台
        run: pnpm -C apps/admin build
        env:
          NEXT_PUBLIC_API_BASE_URL: https://www.thepexels.art/api # 替换为实际域名

      - name: 准备服务器目录
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            # 创建目标目录并设置临时写入权限
            sudo mkdir -p ${{ env.PANEL_BASE_PATH }}/${{ env.SITE_DOMAIN }}
            sudo mkdir -p ${{ env.PANEL_BASE_PATH }}/${{ env.SITE_DOMAIN }}/admin
            sudo chown -R ${{ secrets.SERVER_USER }}:${{ secrets.SERVER_USER }} ${{ env.PANEL_BASE_PATH }}/${{ env.SITE_DOMAIN }}

            # 清理旧文件（保留 admin 目录）
            cd ${{ env.PANEL_BASE_PATH }}/${{ env.SITE_DOMAIN }}
            find . -maxdepth 1 ! -name '.' ! -name '..' ! -name 'admin' -exec rm -rf {} +
            rm -rf admin/*

      - name: 部署 Web 文件到服务器
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: 'apps/web/out/*'
          target: '${{ env.PANEL_BASE_PATH }}/${{ env.SITE_DOMAIN }}/'
          strip_components: 3

      - name: 部署 Admin 文件到服务器
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: 'apps/admin/out/*'
          target: '${{ env.PANEL_BASE_PATH }}/${{ env.SITE_DOMAIN }}/admin/'
          strip_components: 3

      - name: 设置文件权限
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            sudo chown -R www-data:www-data ${{ env.PANEL_BASE_PATH }}/${{ env.SITE_DOMAIN }}
            sudo chmod -R 755 ${{ env.PANEL_BASE_PATH }}/${{ env.SITE_DOMAIN }}

  notify:
    name: 部署通知
    needs: [deploy-backend, deploy-frontend]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: 发送通知
        run: |
          echo "Backend 部署状态: ${{ needs.deploy-backend.result }}"
          echo "Frontend 部署状态: ${{ needs.deploy-frontend.result }}"
          echo "Tag: ${{ github.ref_name }}"
          echo "提交: ${{ github.sha }}"
          # TODO: 可以添加 Slack/钉钉通知
