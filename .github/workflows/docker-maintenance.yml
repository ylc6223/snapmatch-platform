name: Docker Maintenance (Production Server)

on:
  workflow_dispatch: {}
  schedule:
    # 每天凌晨 03:30（UTC）执行一次；可按需要调整
    - cron: '30 3 * * *'

jobs:
  docker-cleanup:
    name: 清理 Docker 缓存与旧资源
    runs-on: ubuntu-latest
    steps:
      - name: 在服务器执行 Docker 清理
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          command_timeout: 30m
          script: |
            set -euo pipefail

            sudo bash << 'ENDSCRIPT'
            set -euo pipefail

            echo "→ Docker 磁盘占用（清理前）"
            docker system df || true

            # 只清理“旧的/无用的”，避免影响正在运行的服务
            # - image prune：只清理 dangling 镜像（不加 -a）
            # - builder prune：清理 BuildKit 构建缓存（通常是大头）
            # - container prune：清理已停止容器
            echo "→ 清理已停止容器（7 天前）"
            docker container prune -f --filter "until=168h" || true

            echo "→ 清理 dangling 镜像（7 天前）"
            docker image prune -f --filter "until=168h" || true

            echo "→ 清理 BuildKit 构建缓存（7 天前）"
            docker builder prune -f --filter "until=168h" || true

            echo "→ Docker 磁盘占用（清理后）"
            docker system df || true

            echo "✅ Docker 清理完成"
            ENDSCRIPT
