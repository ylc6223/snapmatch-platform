# API ç‰ˆæœ¬åŒ–è¿ç§» Checklist

> **è¿ç§»ç›®æ ‡**: æ·»åŠ  `/api/v1` å‰ç¼€åˆ° Backend API
> **æ‰§è¡Œäºº**: ****\_****
> **æ‰§è¡Œæ—¥æœŸ**: ****\_****

---

## ğŸ“‹ è¿ç§»å‰å‡†å¤‡

### 1. ç¯å¢ƒæ£€æŸ¥

- [ ] ç¡®è®¤å½“å‰åœ¨ `main` åˆ†æ”¯
- [ ] æœ¬åœ°ä»£ç ä¸è¿œç¨‹åŒæ­¥ï¼ˆ`git pull origin main`ï¼‰
- [ ] æ— æœªæäº¤çš„ä¿®æ”¹ï¼ˆ`git status` æ˜¾ç¤ºå¹²å‡€ï¼‰
- [ ] æ‰€æœ‰ä¾èµ–å·²å®‰è£…ï¼ˆ`pnpm install`ï¼‰
- [ ] æœ¬åœ°å¼€å‘ç¯å¢ƒå¯ä»¥æ­£å¸¸å¯åŠ¨ï¼ˆ`pnpm dev`ï¼‰

### 2. å¤‡ä»½ä¸åˆ†æ”¯

- [ ] åˆ›å»ºæ–°åˆ†æ”¯ï¼ˆ`git checkout -b feature/api-versioning`ï¼‰
- [ ] å¤‡ä»½ç”Ÿäº§æ•°æ®åº“ï¼ˆå¦‚æœ‰å¿…è¦ï¼‰
- [ ] è®°å½•å½“å‰ç”Ÿäº§ç¯å¢ƒç‰ˆæœ¬å·

---

## ğŸ”§ ä»£ç ä¿®æ”¹æ¸…å•

### Backendï¼ˆ1 ä¸ªæ–‡ä»¶ï¼‰

#### âœ… 1. `apps/backend/src/main.ts`

- [ ] åœ¨ Line 13 åæ·»åŠ  `app.setGlobalPrefix('api/v1');`
- [ ] ä¿å­˜æ–‡ä»¶
- [ ] éªŒè¯è¯­æ³•æ— è¯¯ï¼ˆ`pnpm -C apps/backend lint`ï¼‰

---

### Adminï¼ˆ9 ä¸ªæ–‡ä»¶ï¼‰

#### âœ… 2. `apps/admin/app/api/[...path]/route.ts`

- [ ] **Line 22**: ä¿®æ”¹ `/auth/refresh` â†’ `/api/v1/auth/refresh`
- [ ] **Line 72**: ä¿®æ”¹è·¯å¾„è½¬æ¢é€»è¾‘ä¸º `/api/v1${pathname.slice("/api".length)}`
- [ ] ä¿å­˜æ–‡ä»¶

---

#### âœ… 3. `apps/admin/app/api/auth/login/route.ts`

- [ ] **Line 62**: ä¿®æ”¹ `/auth/login` â†’ `/api/v1/auth/login`
- [ ] **Line 20**: æ›´æ–°æ³¨é‡Šä¸­çš„è·¯å¾„ï¼ˆå¯é€‰ï¼‰
- [ ] ä¿å­˜æ–‡ä»¶

---

#### âœ… 4. `apps/admin/app/api/auth/me/route.ts`

- [ ] **Line 22**: ä¿®æ”¹ `/auth/refresh` â†’ `/api/v1/auth/refresh`
- [ ] **Line 49**: ä¿®æ”¹ `/auth/me` â†’ `/api/v1/auth/me`
- [ ] **Line 75**: ä¿®æ”¹ `/auth/me` â†’ `/api/v1/auth/me`
- [ ] **Line 65**: æ›´æ–°æ³¨é‡Šä¸­çš„è·¯å¾„ï¼ˆå¯é€‰ï¼‰
- [ ] ä¿å­˜æ–‡ä»¶

---

#### âœ… 5. `apps/admin/app/api/auth/logout/route.ts`

- [ ] **Line 17**: ä¿®æ”¹ `/auth/logout` â†’ `/api/v1/auth/logout`
- [ ] ä¿å­˜æ–‡ä»¶

---

#### âœ… 6. `apps/admin/proxy.ts`

- [ ] **Line 57**: ä¿®æ”¹ `/auth/me` â†’ `/api/v1/auth/me`
- [ ] **Line 70**: ä¿®æ”¹ `/auth/refresh` â†’ `/api/v1/auth/refresh`
- [ ] ä¿å­˜æ–‡ä»¶

---

#### âœ… 7. `apps/admin/app/dashboard/layout.tsx`

- [ ] **Line 78**: ä¿®æ”¹ `/auth/me` â†’ `/api/v1/auth/me`
- [ ] ä¿å­˜æ–‡ä»¶

---

### å¥åº·æ£€æŸ¥å†³ç­–ï¼ˆå¯é€‰ï¼‰

#### âœ… 8. Backend å¥åº·æ£€æŸ¥è·¯å¾„

- [ ] **æ–¹æ¡ˆ A**: ä¿æŒ `/health`ï¼ˆæ¨èï¼‰
  - æ— éœ€ä¿®æ”¹ä»£ç 
  - Controller ä½¿ç”¨ `@Controller('health')`ï¼ˆä¸å— globalPrefix å½±å“ï¼‰
- [ ] **æ–¹æ¡ˆ B**: æ”¹ä¸º `/api/v1/health`
  - ä¿®æ”¹ `scripts/server-setup.sh` ä¸­ Nginx å¥åº·æ£€æŸ¥é…ç½®
  - éªŒè¯ Docker healthcheckï¼ˆå¦‚æœ‰ï¼‰

---

## ğŸ§ª æœ¬åœ°æµ‹è¯•éªŒè¯

### é˜¶æ®µ 1: Backend å•ç‹¬æµ‹è¯•

- [ ] å¯åŠ¨ Backendï¼ˆ`pnpm dev:backend`ï¼‰
- [ ] æ— å¯åŠ¨é”™è¯¯
- [ ] è®¿é—®å¥åº·æ£€æŸ¥ç«¯ç‚¹:
  - [ ] `curl http://localhost:3002/health` è¿”å› 200ï¼ˆå¦‚æœä¿æŒæ— å‰ç¼€ï¼‰
  - [ ] `curl http://localhost:3002/api/v1/health` è¿”å› 200ï¼ˆå¦‚æœæ·»åŠ å‰ç¼€ï¼‰
- [ ] æ—§è·¯å¾„è¿”å› 404:
  - [ ] `curl http://localhost:3002/auth/login` â†’ 404 âœ…

---

### é˜¶æ®µ 2: Admin + Backend é›†æˆæµ‹è¯•

- [ ] åŒæ—¶å¯åŠ¨ Admin å’Œ Backendï¼ˆ`pnpm dev`ï¼‰
- [ ] Admin å¯åŠ¨æ— æŠ¥é”™
- [ ] Backend å¯åŠ¨æ— æŠ¥é”™
- [ ] æµè§ˆå™¨è®¿é—® `http://localhost:3001/admin/login` é¡µé¢æ­£å¸¸

---

### é˜¶æ®µ 3: åŠŸèƒ½å®Œæ•´æµ‹è¯•

#### ç™»å½•æµç¨‹

- [ ] æ‰“å¼€ `http://localhost:3001/admin/login`
- [ ] è¾“å…¥æ­£ç¡®çš„è´¦å·å¯†ç ï¼ˆå¦‚ `admin` / `password`ï¼‰
- [ ] ç‚¹å‡»ç™»å½•æŒ‰é’®
- [ ] æˆåŠŸè·³è½¬åˆ° `/admin/dashboard`
- [ ] æ˜¾ç¤ºç”¨æˆ·åå’Œè§’è‰²ä¿¡æ¯

#### Token åˆ·æ–°

- [ ] ç­‰å¾… accessToken è¿‡æœŸï¼ˆæˆ–æ‰‹åŠ¨ä¿®æ”¹ `JWT_EXPIRES_IN` ä¸º 10sï¼‰
- [ ] åˆ·æ–°é¡µé¢æˆ–å‘èµ· API è¯·æ±‚
- [ ] è‡ªåŠ¨åˆ·æ–° tokenï¼Œæ— éœ€é‡æ–°ç™»å½•
- [ ] æ£€æŸ¥ Network é¢æ¿ï¼Œç¡®è®¤è°ƒç”¨äº† `/api/auth/me` å’Œè‡ªåŠ¨ refresh

#### ç”¨æˆ·ä¿¡æ¯è·å–

- [ ] ç™»å½•åè®¿é—® `/admin/dashboard`
- [ ] å³ä¸Šè§’æ˜¾ç¤ºå½“å‰ç”¨æˆ·å¤´åƒå’Œåç§°
- [ ] ç‚¹å‡»ç”¨æˆ·èœå•ï¼Œæ˜¾ç¤ºè§’è‰²ä¿¡æ¯

#### ç™»å‡ºæµç¨‹

- [ ] ç‚¹å‡»å³ä¸Šè§’ç”¨æˆ·èœå•
- [ ] ç‚¹å‡»"é€€å‡ºç™»å½•"
- [ ] è·³è½¬å›ç™»å½•é¡µ `/admin/login`
- [ ] å°è¯•è®¿é—® `/admin/dashboard`ï¼Œè‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µ

#### RBAC æƒé™

- [ ] ä»¥ `admin` è§’è‰²ç™»å½•ï¼Œå¯ä»¥è®¿é—®æ‰€æœ‰èœå•
- [ ] ä»¥ `visitor` è§’è‰²ç™»å½•ï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œåªèƒ½è®¿é—®éƒ¨åˆ†èœå•
- [ ] å°è¯•è®¿é—®æ— æƒé™é¡µé¢ï¼Œæ˜¾ç¤º 403 é”™è¯¯

---

### é˜¶æ®µ 4: é”™è¯¯åœºæ™¯æµ‹è¯•

#### Backend æœªå¯åŠ¨

- [ ] åœæ­¢ Backendï¼ˆ`Ctrl+C`ï¼‰
- [ ] åˆ·æ–° Admin é¡µé¢
- [ ] æ˜¾ç¤º "Bad Gateway (502)" é”™è¯¯æç¤º

#### é”™è¯¯å¯†ç ç™»å½•

- [ ] è¾“å…¥é”™è¯¯çš„å¯†ç 
- [ ] æ˜¾ç¤º "è´¦å·æˆ–å¯†ç é”™è¯¯" æç¤º
- [ ] ä¸ä¼šè·³è½¬é¡µé¢

#### ä¼šè¯è¿‡æœŸ

- [ ] æ‰‹åŠ¨åˆ é™¤ accessToken å’Œ refreshToken cookie
- [ ] åˆ·æ–° `/admin/dashboard`
- [ ] å¼¹å‡ºä¼šè¯è¿‡æœŸå¯¹è¯æ¡†
- [ ] ç‚¹å‡»"é‡æ–°ç™»å½•"ï¼Œè·³è½¬åˆ°ç™»å½•é¡µå¹¶ä¿ç•™ `next` å‚æ•°

---

## ğŸ“¦ ä»£ç æäº¤ä¸å®¡æŸ¥

### Git æ“ä½œ

- [ ] æŸ¥çœ‹æ‰€æœ‰ä¿®æ”¹ï¼ˆ`git diff`ï¼‰
- [ ] ç¡®è®¤ä¿®æ”¹äº† 10 ä¸ªæ–‡ä»¶ï¼ˆ1 Backend + 9 Adminï¼‰
- [ ] æš‚å­˜æ‰€æœ‰ä¿®æ”¹ï¼ˆ`git add .`ï¼‰
- [ ] æäº¤ä»£ç ï¼š

  ```bash
  git commit -m "feat: add API versioning with /api/v1 prefix

  - Backend: add globalPrefix 'api/v1'
  - Admin: update all hardcoded backend paths
  - Docs: add migration guide and checklist
  "
  ```

- [ ] æ¨é€åˆ°è¿œç¨‹åˆ†æ”¯ï¼ˆ`git push origin feature/api-versioning`ï¼‰

---

### Pull Request

- [ ] åœ¨ GitHub åˆ›å»º PR
- [ ] PR æ ‡é¢˜ï¼š`feat: add API versioning with /api/v1 prefix`
- [ ] PR æè¿°åŒ…å«:
  - [ ] ä¿®æ”¹å†…å®¹æ‘˜è¦
  - [ ] æµ‹è¯•éªŒè¯ç»“æœ
  - [ ] ç›¸å…³æ–‡æ¡£é“¾æ¥
- [ ] æ ‡è®°ä¸º "breaking change"ï¼ˆå¦‚æœ‰ changelogï¼‰
- [ ] è¯·æ±‚è‡³å°‘ 1 äººå®¡æŸ¥

---

### CI/CD æ£€æŸ¥

- [ ] GitHub Actions è´¨é‡æ£€æŸ¥é€šè¿‡
  - [ ] Lint æ£€æŸ¥ï¼ˆWeb/Admin/Backendï¼‰
  - [ ] TypeScript ç±»å‹æ£€æŸ¥
  - [ ] Backend å•å…ƒæµ‹è¯•
- [ ] Code Review å®Œæˆå¹¶æ‰¹å‡†
- [ ] è§£å†³æ‰€æœ‰ Review æ„è§

---

## ğŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

### éƒ¨ç½²å‰æ£€æŸ¥

- [ ] PR å·²åˆå¹¶åˆ° `main` åˆ†æ”¯
- [ ] æœ¬åœ°åˆ‡æ¢åˆ° `main` å¹¶åŒæ­¥ï¼ˆ`git checkout main && git pull`ï¼‰
- [ ] åˆ›å»ºç‰ˆæœ¬æ ‡ç­¾ï¼ˆ`git tag v1.1.0`ï¼‰
- [ ] æ¨é€æ ‡ç­¾ï¼ˆ`git push origin v1.1.0`ï¼‰
- [ ] ç¡®è®¤ `.env` æ–‡ä»¶å·²æ›´æ–°ï¼ˆå¦‚æœ‰æ–°å¢å˜é‡ï¼‰

---

### è‡ªåŠ¨éƒ¨ç½²ï¼ˆGitHub Actionsï¼‰

- [ ] GitHub Actions è§¦å‘æ„å»º
- [ ] è´¨é‡æ£€æŸ¥ Job é€šè¿‡
- [ ] Backend Docker é•œåƒæ„å»ºæˆåŠŸ
- [ ] å‰ç«¯é™æ€æ–‡ä»¶æ„å»ºæˆåŠŸ
- [ ] éƒ¨ç½²åˆ°æœåŠ¡å™¨æˆåŠŸ

---

### æ‰‹åŠ¨éƒ¨ç½²éªŒè¯ï¼ˆå¦‚éœ€è¦ï¼‰

- [ ] SSH ç™»å½•ç”Ÿäº§æœåŠ¡å™¨
- [ ] éªŒè¯ Backend å®¹å™¨è¿è¡ŒçŠ¶æ€ï¼ˆ`docker ps`ï¼‰
- [ ] éªŒè¯ Nginx é…ç½®ï¼ˆ`sudo nginx -t`ï¼‰
- [ ] é‡è½½ Nginxï¼ˆ`sudo systemctl reload nginx`ï¼‰

---

## âœ… ç”Ÿäº§ç¯å¢ƒéªŒè¯

### å¥åº·æ£€æŸ¥

- [ ] è®¿é—®å¥åº·æ£€æŸ¥ç«¯ç‚¹ï¼š
  ```bash
  curl https://yourdomain.com/health
  # æœŸæœ›è¿”å›: {"status":"ok"}
  ```

### API ç«¯ç‚¹éªŒè¯

- [ ] æµ‹è¯•æœªç™»å½•è®¿é—®ï¼ˆåº”è¿”å› 401ï¼‰ï¼š

  ```bash
  curl https://yourdomain.com/api/auth/me
  # æœŸæœ›è¿”å›: {"code":401,"message":"æœªç™»å½•"}
  ```

- [ ] æµ‹è¯•ç™»å½•æ¥å£ï¼ˆåº”è¿”å› 200ï¼‰ï¼š
  ```bash
  curl -X POST https://yourdomain.com/api/auth/login \
    -H "Content-Type: application/json" \
    -d '{"account":"testuser","password":"testpass"}'
  # æœŸæœ›è¿”å›: {"code":200,"data":{"user":{...}}}
  ```

---

### å‰ç«¯åŠŸèƒ½éªŒè¯

- [ ] æ‰“å¼€ç”Ÿäº§ç¯å¢ƒ Admin ç™»å½•é¡µ
- [ ] æ‰§è¡Œå®Œæ•´ç™»å½•æµç¨‹
- [ ] éªŒè¯æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½:
  - [ ] ç™»å½•æˆåŠŸ
  - [ ] Token è‡ªåŠ¨åˆ·æ–°
  - [ ] ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
  - [ ] æƒé™æ£€æŸ¥æ­£å¸¸
  - [ ] ç™»å‡ºåŠŸèƒ½æ­£å¸¸

---

### ç›‘æ§æ£€æŸ¥

- [ ] æ£€æŸ¥ Backend é”™è¯¯æ—¥å¿—ï¼ˆæ— æ–°å¢é”™è¯¯ï¼‰
- [ ] æ£€æŸ¥ Admin é”™è¯¯æ—¥å¿—ï¼ˆæ— æ–°å¢é”™è¯¯ï¼‰
- [ ] æ£€æŸ¥ Nginx é”™è¯¯æ—¥å¿—ï¼ˆæ— æ–°å¢é”™è¯¯ï¼‰
- [ ] API å“åº”æ—¶é—´æ­£å¸¸ï¼ˆæ— æ˜æ˜¾å¢åŠ ï¼‰

---

## ğŸ” é—®é¢˜æ’æŸ¥ï¼ˆå¦‚é‡åˆ°é—®é¢˜ï¼‰

### å¸¸è§é—®é¢˜æ£€æŸ¥æ¸…å•

#### é—®é¢˜ 1: 404 Not Found

- [ ] ç¡®è®¤ Backend `app.setGlobalPrefix('api/v1')` å·²æ·»åŠ 
- [ ] ç¡®è®¤æ‰€æœ‰ Admin ç¡¬ç¼–ç è·¯å¾„å·²ä¿®æ”¹
- [ ] æ£€æŸ¥è·¯å¾„æ‹¼æ¥æ˜¯å¦æ­£ç¡®ï¼ˆ`/api/v1` ä¸è¦å¤šåŠ æˆ–å°‘åŠ æ–œæ ï¼‰
- [ ] æŸ¥çœ‹ Backend æ—¥å¿—ï¼Œç¡®è®¤æ”¶åˆ°è¯·æ±‚

#### é—®é¢˜ 2: 502 Bad Gateway

- [ ] ç¡®è®¤ Backend å·²å¯åŠ¨ï¼ˆ`curl http://localhost:3002/health`ï¼‰
- [ ] æ£€æŸ¥ `BACKEND_BASE_URL` ç¯å¢ƒå˜é‡æ˜¯å¦æ­£ç¡®
- [ ] æŸ¥çœ‹ Backend æ˜¯å¦ç›‘å¬æ­£ç¡®ç«¯å£

#### é—®é¢˜ 3: 401 Unauthorized

- [ ] ç¡®è®¤ JWT_SECRET æ­£ç¡®é…ç½®
- [ ] æ£€æŸ¥ accessToken æ˜¯å¦æ­£ç¡®ä¼ é€’
- [ ] æŸ¥çœ‹ Backend æ—¥å¿—ä¸­çš„ JWT éªŒè¯é”™è¯¯

#### é—®é¢˜ 4: ä¼šè¯åˆ·æ–°å¤±è´¥

- [ ] ç¡®è®¤ `/api/v1/auth/refresh` è·¯å¾„æ­£ç¡®
- [ ] æ£€æŸ¥ refreshToken æ˜¯å¦åœ¨ cookie ä¸­
- [ ] æŸ¥çœ‹ Backend refresh ç«¯ç‚¹æ—¥å¿—

---

## ğŸ”„ å›æ»šæ–¹æ¡ˆï¼ˆå¦‚æœéœ€è¦ï¼‰

### ç´§æ€¥å›æ»šæ­¥éª¤

- [ ] ç¡®è®¤éœ€è¦å›æ»šï¼ˆä¸¥é‡åŠŸèƒ½å¼‚å¸¸ï¼‰
- [ ] é€šçŸ¥å›¢é˜Ÿæˆå‘˜
- [ ] æ‰§è¡Œ Git å›æ»šï¼š
  ```bash
  git revert v1.1.0
  git push origin main
  ```
- [ ] æˆ–å›æ»šå®¹å™¨ï¼š
  ```bash
  docker rollback snapmatch-backend
  sudo systemctl reload nginx
  ```
- [ ] éªŒè¯å›æ»šæˆåŠŸï¼ˆæ—§ç‰ˆæœ¬åŠŸèƒ½æ­£å¸¸ï¼‰
- [ ] è®°å½•é—®é¢˜åŸå› 
- [ ] ä¿®å¤é—®é¢˜åé‡æ–°éƒ¨ç½²

---

## ğŸ“ è¿ç§»å®Œæˆç¡®è®¤

### æœ€ç»ˆéªŒè¯

- [ ] æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹é€šè¿‡
- [ ] ç”Ÿäº§ç¯å¢ƒåŠŸèƒ½æ­£å¸¸
- [ ] æ— ç”¨æˆ·æŠ•è¯‰å’Œé”™è¯¯æŠ¥å‘Š
- [ ] ç›‘æ§æŒ‡æ ‡æ­£å¸¸ï¼ˆå“åº”æ—¶é—´ã€é”™è¯¯ç‡ï¼‰
- [ ] æ–‡æ¡£å·²æ›´æ–°

### æ–‡æ¡£æ›´æ–°

- [ ] æ›´æ–° `README.md` ä¸­çš„ API ç¤ºä¾‹
- [ ] æ›´æ–° `docs/architecture/overview.md` ä¸­çš„ API è·¯å¾„
- [ ] æ›´æ–° `docs/backend/README.md` ä¸­çš„è·¯å¾„è¯´æ˜
- [ ] æ ‡è®°æœ¬ checklist ä¸º"å·²å®Œæˆ"
- [ ] å½’æ¡£è¿ç§»æ–‡æ¡£

---

## âœï¸ ç­¾å­—ç¡®è®¤

| è§’è‰²   | å§“å       | ç­¾å­—       | æ—¥æœŸ       |
| ------ | ---------- | ---------- | ---------- |
| æ‰§è¡Œäºº | **\_\_\_** | **\_\_\_** | **\_\_\_** |
| å®¡æ ¸äºº | **\_\_\_** | **\_\_\_** | **\_\_\_** |
| æ‰¹å‡†äºº | **\_\_\_** | **\_\_\_** | **\_\_\_** |

---

## ğŸ“ é™„å½•

### å¿«é€Ÿå‘½ä»¤å‚è€ƒ

```bash
# åˆ›å»ºåˆ†æ”¯
git checkout -b feature/api-versioning

# æŸ¥çœ‹ä¿®æ”¹
git diff

# æäº¤ä»£ç 
git add .
git commit -m "feat: add API versioning with /api/v1 prefix"
git push origin feature/api-versioning

# æœ¬åœ°æµ‹è¯•
pnpm dev

# æµ‹è¯•å¥åº·æ£€æŸ¥
curl http://localhost:3002/health

# æµ‹è¯• API
curl http://localhost:3002/api/v1/health

# ç”Ÿäº§éƒ¨ç½²
git tag v1.1.0
git push origin v1.1.0
```

---

**è¿ç§»çŠ¶æ€**: â¬œ æœªå¼€å§‹ / â³ è¿›è¡Œä¸­ / âœ… å·²å®Œæˆ

**æœ€åæ›´æ–°**: 2025-12-31
