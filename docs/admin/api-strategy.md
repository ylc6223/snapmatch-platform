# 后台（Admin）API 请求与数据流方案（面向微信小程序内容配置）

适用场景：本后台用于配置摄影师约拍微信小程序的内容（图片展示、套系上架、文案、排序、状态等）。

---

## 1. 技术选型（Next.js）

### 1.1 请求库选择

- **推荐默认：原生 `fetch` + 自封装 `request()`**
  - 与 Next.js 的 Server Components / Route Handlers / 缓存语义（`revalidate`/`tags`）契合
  - 依赖更少、可控性更高
- **可选：Axios**
  - 优点：拦截器、取消请求、上传进度等能力成熟
  - 注意：在 Next 的服务端缓存语义上不如 `fetch` 原生顺滑
- **客户端数据状态管理（按需）**
  - **TanStack Query（React Query）**：适合后台表格/筛选/分页/刷新频繁的页面
  - **SWR**：更轻量的客户端缓存方案

建议：**默认 fetch**，如果后台页面大量表格、筛选、分页，再加 **TanStack Query** 管理请求状态。

---

## 2. 推荐数据获取架构（后台）

### 2.1 读（查询）

后台的“列表/详情”类页面（套系列表、图片素材库、预约列表等）：

- Client Component：负责交互（筛选、分页、排序、搜索）
- 请求层：`fetch`（或 axios）
- **如交互复杂**：用 TanStack Query 管缓存/重试/失焦刷新等

### 2.2 写（新增/修改/上架/下架）

后台“编辑/保存”类操作建议走服务端：

- **Server Actions** 或 **Route Handlers（`app/api/*`）**
- 服务端统一做：
  - 权限校验（管理员/摄影师角色）
  - 参数校验（Schema）
  - 写库、写审计日志

原则：**写入能力放在服务端，前端只负责表单与展示**。

---

## 3. 图片上传与存储（关键点）

不建议让后台或小程序把图片“经由 Next.js 服务中转上传”，避免：

- 带宽成本高、延迟高
- 服务器压力与失败重试复杂

推荐：**对象存储直传（Signed URL / STS）**

1. 后台请求服务端拿到上传凭证（签名 URL/临时密钥）
2. 浏览器直接上传到对象存储
3. 后台把“图片 URL + 元数据”写入数据库

元数据建议包含：

- `url`（存储地址）
- `width/height`（可选）
- `size`（可选）
- `type`（封面/详情/轮播/案例图）
- `sort`（排序）
- `status`（启用/禁用）
- `packageId`（关联套系）

---

## 4. 小程序侧数据访问建议

小程序建议只读一个稳定的“内容 API”，返回聚合后的结构：

- 套系列表（名称、价格、标签、上下架状态、封面图）
- 套系详情（图集、文案、注意事项、拍摄流程等）
- 运营配置（首页 banner、推荐位、活动文案等）

并支持：

- `updatedAt`/版本号：用于小程序本地缓存与增量刷新
- 统一的错误码/提示文案：便于小程序做兜底

---

## 5. 鉴权与权限控制

后台建议使用 Cookie Session 或 JWT（二选一即可），但务必保证：

- **写接口必须在服务端校验权限**
- 角色建议至少区分：
  - `admin`：全量配置、发布
  - `photographer`（可选）：只管理自己的套系/图集

---

## 6. 建议的接口划分（示例）

按资源划分更清晰：

- `GET /api/packages`：套系列表
- `POST /api/packages`：创建套系
- `PATCH /api/packages/:id`：更新套系
- `POST /api/packages/:id/publish`：上架
- `POST /api/packages/:id/unpublish`：下架
- `GET /api/assets`：素材列表（图片/视频）
- `POST /api/assets/sign`：获取直传签名
- `POST /api/content/home`：首页配置保存

---

## 7. 最小可行落地路线（MVP）

1. 先做套系 CRUD（名称/价格/上下架/排序）
2. 接入图片直传与素材管理（封面/详情图）
3. 小程序只读套系 + 详情渲染
4. 逐步补齐文案、推荐位、运营配置
