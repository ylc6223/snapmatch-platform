# é¡¹ç›®ç®¡ç†ç•Œé¢å¼€å‘

> **æ‰€å±é˜¶æ®µ**ï¼š[å‰ç«¯å¼€å‘ï¼ˆç®¡ç†åå°ï¼‰](./README.md)
> **é¢„è®¡æ—¶é•¿**ï¼š3-4 å°æ—¶
> **éš¾åº¦ç­‰çº§**ï¼šâ­â­â­â­â˜†

## ğŸ“‹ ç« èŠ‚å¤§çº²

### ç¬¬ä¸€éƒ¨åˆ†ï¼šæ¦‚è¿°

- ä¸šåŠ¡åœºæ™¯ä¸åŠŸèƒ½éœ€æ±‚
- æŠ€æœ¯æ ˆä¸æ¶æ„è®¾è®¡
- é¡µé¢ç»“æ„ä¸è·¯ç”±è§„åˆ’
- ç»„ä»¶å±‚æ¬¡ä¸èŒè´£åˆ’åˆ†

### ç¬¬äºŒéƒ¨åˆ†ï¼šè¯¦ç»†è¯´æ˜

- å‡†å¤‡å·¥ä½œï¼šç›®å½•ç»“æ„ä¸è·¯ç”±é…ç½®
- API å®¢æˆ·ç«¯ï¼šç±»å‹å®šä¹‰ä¸è¯·æ±‚å°è£…
- é¡¹ç›®åˆ—è¡¨é¡µï¼šè¡¨æ ¼å±•ç¤ºä¸æ“ä½œ
- åˆ›å»ºé¡¹ç›®é¡µï¼šè¡¨å•éªŒè¯ä¸æäº¤
- ç…§ç‰‡åˆ—è¡¨é¡µï¼šç½‘æ ¼å±•ç¤ºä¸ä¸Šä¼ 
- React Query Hooksï¼šæ•°æ®è·å–ä¸ç¼“å­˜

### ç¬¬ä¸‰éƒ¨åˆ†ï¼šå®è·µç¤ºä¾‹

- å®Œæ•´çš„é¡¹ç›®åˆ›å»ºæµç¨‹
- ç…§ç‰‡ä¸Šä¼ ä¸ç¡®è®¤æµç¨‹
- å®¢æˆ·é“¾æ¥ç”Ÿæˆä¸åˆ†äº«

### ç¬¬å››éƒ¨åˆ†ï¼šæ€»ç»“ä¸æœ€ä½³å®è·µ

- ç»„ä»¶è®¾è®¡åŸåˆ™å›é¡¾
- çŠ¶æ€ç®¡ç†æœ€ä½³å®è·µ
- ç”¨æˆ·ä½“éªŒä¼˜åŒ–å»ºè®®
- å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

---

## ğŸ¯ å­¦ä¹ ç›®æ ‡

é€šè¿‡æœ¬æ•™ç¨‹ï¼Œä½ å°†å­¦ä¼šï¼š

- [ ] ä½¿ç”¨ Next.js 13+ App Router æ„å»ºå¤šé¡µé¢åº”ç”¨
- [ ] ä½¿ç”¨ React Query ç®¡ç†æœåŠ¡å™¨çŠ¶æ€
- [ ] ä½¿ç”¨ shadcn/ui æ„å»ºé«˜è´¨é‡ç•Œé¢
- [ ] ä½¿ç”¨ react-hook-form + zod å®ç°è¡¨å•éªŒè¯
- [ ] å®ç°æ–‡ä»¶ä¸Šä¼ ä¸è¿›åº¦æ˜¾ç¤º
- [ ] å¤„ç†åŠ è½½ã€é”™è¯¯ã€æˆåŠŸç­‰çŠ¶æ€

## ğŸ’¡ å…³é”®è¦ç‚¹

- **é¡¹ç›®ï¼ˆProjectï¼‰**æ˜¯ç»„ç»‡ç…§ç‰‡çš„æ ¸å¿ƒå®ä½“ï¼Œåˆ—è¡¨é¡µå±•ç¤ºæ‰€æœ‰é¡¹ç›®
- **ç…§ç‰‡ï¼ˆPhotoï¼‰**å…³è”åˆ°é¡¹ç›®ï¼Œé€šè¿‡ç½‘æ ¼å¸ƒå±€å±•ç¤º
- ä½¿ç”¨ **React Query** çš„ `useQuery` å’Œ `useMutation` ç®¡ç†æœåŠ¡å™¨çŠ¶æ€
- **shadcn/ui** æä¾›äº†ä¸€å¥—å¯å®šåˆ¶çš„ UI ç»„ä»¶ï¼ŒåŸºäº Radix UI å’Œ Tailwind CSS
- è¡¨å•éªŒè¯ä½¿ç”¨ **react-hook-form** + **zod**ï¼Œç±»å‹å®‰å…¨ä¸”ç”¨æˆ·å‹å¥½

---

## ç¬¬ä¸€éƒ¨åˆ†ï¼šæ¦‚è¿°

### 1.1 ä¸šåŠ¡åœºæ™¯

åœ¨æ‘„å½±æœåŠ¡ç®¡ç†åå°ï¼Œç®¡ç†å‘˜éœ€è¦ï¼š

1. **æŸ¥çœ‹é¡¹ç›®åˆ—è¡¨**ï¼šæµè§ˆæ‰€æœ‰é¡¹ç›®ï¼ŒæŸ¥çœ‹ç…§ç‰‡æ•°é‡ã€çŠ¶æ€ç­‰
2. **åˆ›å»ºæ–°é¡¹ç›®**ï¼šå¡«å†™é¡¹ç›®ä¿¡æ¯ï¼Œç”Ÿæˆè®¿é—®é“¾æ¥
3. **ä¸Šä¼ ç…§ç‰‡**ï¼šä¸ºæŒ‡å®šé¡¹ç›®æ‰¹é‡ä¸Šä¼ ç…§ç‰‡
4. **ç®¡ç†ç…§ç‰‡**ï¼šæŸ¥çœ‹ã€åˆ é™¤é¡¹ç›®ä¸­çš„ç…§ç‰‡
5. **åˆ†äº«é“¾æ¥**ï¼šå¤åˆ¶é€‰ç‰‡é“¾æ¥å‘é€ç»™å®¢æˆ·

### 1.2 æŠ€æœ¯æ ˆ

æœ¬é¡¹ç›®ä½¿ç”¨ä»¥ä¸‹æŠ€æœ¯æ ˆï¼š

| æŠ€æœ¯                | ç‰ˆæœ¬                  | ç”¨é€”                   |
| ------------------- | --------------------- | ---------------------- |
| **Next.js**         | 13+                   | React æ¡†æ¶ï¼ŒApp Router |
| **TypeScript**      | 5+                    | ç±»å‹å®‰å…¨               |
| **React Query**     | @tanstack/react-query | æœåŠ¡å™¨çŠ¶æ€ç®¡ç†         |
| **shadcn/ui**       | latest                | UI ç»„ä»¶åº“              |
| **react-hook-form** | latest                | è¡¨å•ç®¡ç†               |
| **zod**             | latest                | Schema éªŒè¯            |
| **Tailwind CSS**    | latest                | æ ·å¼ç³»ç»Ÿ               |

### 1.3 é¡µé¢ç»“æ„

```mermaid
graph TD
    Root[Dashboard Layout]

    Root --> List[é¡¹ç›®åˆ—è¡¨é¡µ<br/>/dashboard/delivery/projects]
    Root --> New[åˆ›å»ºé¡¹ç›®é¡µ<br/>/dashboard/delivery/projects/new]
    Root --> Detail[é¡¹ç›®è¯¦æƒ…é¡µ<br/>/dashboard/delivery/projects/[id]]
    Root --> Photos[ç…§ç‰‡åˆ—è¡¨é¡µ<br/>/dashboard/delivery/photos/[projectId]]

    List --> Table[ProjectTable ç»„ä»¶]
    List --> CreateBtn[CreateProjectButton ç»„ä»¶]

    New --> Form[CreateProjectForm ç»„ä»¶]

    Photos --> Grid[PhotoGrid ç»„ä»¶]
    Photos --> UploadBtn[PhotoUploadButton ç»„ä»¶]

    style Root fill:#e1f5ff
    style List fill:#fff4e1
    style New fill:#fff4e1
    style Photos fill:#f0e1ff
```

### 1.4 ç»„ä»¶å±‚æ¬¡

**é¡¹ç›®åˆ—è¡¨é¡µ** (`/dashboard/delivery/projects/page.tsx`)ï¼š

```
ProjectsListPage
â”œâ”€â”€ PageHeader
â”‚   â”œâ”€â”€ Title ("é¡¹ç›®ç®¡ç†")
â”‚   â””â”€â”€ Description ("ç®¡ç†ç…§ç‰‡é¡¹ç›®å’Œé€‰ç‰‡é“¾æ¥")
â””â”€â”€ ProjectTable
    â”œâ”€â”€ TableHeader (åˆ—å)
    â”œâ”€â”€ TableBody (æ•°æ®è¡Œ)
    â”‚   â””â”€â”€ ProjectRow
    â”‚       â”œâ”€â”€ NameCell (é¡¹ç›®åç§°)
    â”‚       â”œâ”€â”€ PhotoCountCell (ç…§ç‰‡æ•°é‡)
    â”‚       â”œâ”€â”€ StatusCell (çŠ¶æ€å¾½ç« )
    â”‚       â”œâ”€â”€ CreatedAtCell (åˆ›å»ºæ—¶é—´)
    â”‚       â””â”€â”€ ActionsCell (æ“ä½œèœå•)
    â”‚           â”œâ”€â”€ ViewButton
    â”‚           â”œâ”€â”€ EditButton
    â”‚           â”œâ”€â”€ CopyLinkButton
    â”‚           â””â”€â”€ DeleteButton
    â””â”€â”€ Pagination (åˆ†é¡µå™¨)
```

**åˆ›å»ºé¡¹ç›®é¡µ** (`/dashboard/delivery/projects/new/page.tsx`)ï¼š

```
NewProjectPage
â”œâ”€â”€ Breadcrumb (é¢åŒ…å±‘å¯¼èˆª)
â””â”€â”€ CreateProjectForm
    â”œâ”€â”€ FormField (name)
    â”‚   â”œâ”€â”€ Label
    â”‚   â”œâ”€â”€ Input
    â”‚   â””â”€â”€ Message (éªŒè¯é”™è¯¯)
    â”œâ”€â”€ FormField (description)
    â”‚   â”œâ”€â”€ Label
    â”‚   â”œâ”€â”€ Textarea
    â”‚   â””â”€â”€ Message
    â””â”€â”€ SubmitButton
```

---

## ç¬¬äºŒéƒ¨åˆ†ï¼šè¯¦ç»†è¯´æ˜

### 2.1 å‡†å¤‡å·¥ä½œ

#### 2.1.1 åˆ›å»ºç›®å½•ç»“æ„

é¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•å’Œæ–‡ä»¶ï¼š

```bash
# é¡µé¢ç›®å½•
mkdir -p apps/admin/app/dashboard/delivery/projects
mkdir -p apps/admin/app/dashboard/delivery/projects/new
mkdir -p apps/admin/app/dashboard/delivery/photos/[projectId]
mkdir -p apps/admin/app/dashboard/delivery/projects/[id]

# ç»„ä»¶ç›®å½•
mkdir -p apps/admin/app/dashboard/delivery/projects/components
mkdir -p apps/admin/app/dashboard/delivery/photos/[projectId]/components

# API å’Œ Features
mkdir -p apps/admin/lib/api
mkdir -p apps/admin/lib/features/projects
```

#### 2.1.2 é…ç½®è·¯ç”±å’Œå¯¼èˆª

åœ¨ `apps/admin/lib/navigation/dashboard-tabs.ts` æ·»åŠ é¡¹ç›®ç®¡ç†æ ‡ç­¾ï¼š

```typescript
import { FolderOpen } from 'lucide-react';

export const dashboardTabs = [
  // ... ç°æœ‰æ ‡ç­¾
  {
    title: 'é¡¹ç›®ç®¡ç†',
    href: '/dashboard/delivery/projects',
    icon: FolderOpen,
    permission: 'projects:read',
  },
  // ... å…¶ä»–æ ‡ç­¾
];
```

**æƒé™é…ç½®**ï¼šç¡®ä¿å½“å‰ç”¨æˆ·æœ‰ `projects:read` æƒé™æ‰èƒ½è®¿é—®æ­¤é¡µé¢ã€‚

---

### 2.2 API å®¢æˆ·ç«¯

#### 2.2.1 ç±»å‹å®šä¹‰

**æ–‡ä»¶**ï¼š`apps/admin/lib/api/projects.ts`

```typescript
export interface Project {
  id: string;
  name: string;
  description: string | null;
  token: string;
  viewerUrl: string;
  expiresAt: number | null;
  status: string; // 'active' | 'submitted' | 'expired' | 'revoked'
  photoCount: number;
  createdAt: number;
  updatedAt: number;
}

export interface CreateProjectDto {
  name: string;
  description?: string;
  expiresAt?: number;
}

export interface UpdateProjectDto {
  name?: string;
  description?: string;
  expiresAt?: number;
  status?: string;
}

export interface Photo {
  id: string;
  projectId: string;
  filename: string;
  originalKey: string;
  previewKey: string;
  thumbKey: string | null;
  fileSize: number | null;
  width: number | null;
  height: number | null;
  status: string;
  selected: boolean;
  selectedAt: number | null;
  createdAt: number;
}

export interface QueryParams {
  page?: number;
  limit?: number;
  status?: string;
  search?: string;
}
```

**ç±»å‹è®¾è®¡è¯´æ˜**ï¼š

- **Project**ï¼šå®Œæ•´çš„é¡¹ç›®ä¿¡æ¯ï¼ŒåŒ…å« `viewerUrl` è®¡ç®—å­—æ®µ
- **CreateProjectDto**ï¼šåˆ›å»ºé¡¹ç›®çš„è¾“å…¥ï¼Œæ‰€æœ‰å­—æ®µéƒ½æ˜¯å¯é€‰çš„ï¼ˆé™¤äº† `name`ï¼‰
- **Photo**ï¼šç…§ç‰‡å…ƒæ•°æ®ï¼ŒåŒ…å« R2 å¯¹è±¡ key å’Œé€‰ä¸­çŠ¶æ€
- **QueryParams**ï¼šæŸ¥è¯¢å‚æ•°ï¼Œæ”¯æŒåˆ†é¡µã€ç­›é€‰ã€æœç´¢

#### 2.2.2 API æ–¹æ³•å®ç°

**æ–‡ä»¶**ï¼š`apps/admin/lib/api/projects.ts`ï¼ˆç»­ï¼‰

```typescript
import { apiClient } from '../api-client';

export const projectsApi = {
  /**
   * åˆ›å»ºé¡¹ç›®
   */
  async create(data: CreateProjectDto): Promise<Project> {
    const { data: project } = await apiClient.post<Project>('/api/projects', data);
    return project;
  },

  /**
   * è·å–é¡¹ç›®åˆ—è¡¨
   */
  async findAll(params?: QueryParams): Promise<Project[]> {
    const { data: projects } = await apiClient.get<Project[]>('/api/projects', { params });
    return projects;
  },

  /**
   * è·å–å•ä¸ªé¡¹ç›®
   */
  async findOne(id: string): Promise<Project> {
    const { data: project } = await apiClient.get<Project>(`/api/projects/${id}`);
    return project;
  },

  /**
   * æ›´æ–°é¡¹ç›®
   */
  async update(id: string, data: UpdateProjectDto): Promise<Project> {
    const { data: project } = await apiClient.patch<Project>(`/api/projects/${id}`, data);
    return project;
  },

  /**
   * åˆ é™¤é¡¹ç›®
   */
  async remove(id: string): Promise<void> {
    await apiClient.delete(`/api/projects/${id}`);
  },

  /**
   * è·å–é¡¹ç›®ç…§ç‰‡åˆ—è¡¨
   */
  async findPhotos(projectId: string): Promise<Photo[]> {
    const { data: photos } = await apiClient.get<Photo[]>(`/api/projects/${projectId}/photos`);
    return photos;
  },

  /**
   * åˆ é™¤ç…§ç‰‡
   */
  async removePhotos(projectId: string, photoIds: string[]): Promise<void> {
    await apiClient.delete(`/api/projects/${projectId}/photos`, { data: { photoIds } });
  },
};
```

**é”™è¯¯å¤„ç†**ï¼š

`apiClient` åº”è¯¥å…¨å±€å¤„ç†é”™è¯¯ï¼Œæ˜¾ç¤º toast æç¤ºã€‚ç¤ºä¾‹å®ç°ï¼š

```typescript
// apps/admin/lib/api-client.ts
import axios from 'axios';
import { toast } from 'sonner';

export const apiClient = axios.create({
  baseURL: process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3002',
});

apiClient.interceptors.response.use(
  (response) => response,
  (error) => {
    const message = error.response?.data?.message || 'æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•';
    toast.error(message);
    return Promise.reject(error);
  },
);
```

---

### 2.3 é¡¹ç›®åˆ—è¡¨é¡µ

#### 2.3.1 é¡µé¢ç»„ä»¶

**æ–‡ä»¶**ï¼š`apps/admin/app/dashboard/delivery/projects/page.tsx`

```typescript
import { Button } from '@/components/ui/button';
import { ProjectTable } from './components/ProjectTable';
import { CreateProjectButton } from './components/CreateProjectButton';

export default function ProjectsListPage() {
  return (
    <div className="space-y-6">
      {/* é¡µé¢æ ‡é¢˜ */}
      <div className="flex justify-between items-center">
        <div>
          <h1 className="text-3xl font-bold tracking-tight">é¡¹ç›®ç®¡ç†</h1>
          <p className="text-muted-foreground mt-2">
            ç®¡ç†ç…§ç‰‡é¡¹ç›®å’Œé€‰ç‰‡é“¾æ¥
          </p>
        </div>
        <CreateProjectButton />
      </div>

      {/* é¡¹ç›®è¡¨æ ¼ */}
      <ProjectTable />
    </div>
  );
}
```

**å¸ƒå±€è¯´æ˜**ï¼š

- **é¡¶éƒ¨åŒºåŸŸ**ï¼šå·¦ä¾§æ ‡é¢˜å’Œæè¿°ï¼Œå³ä¾§"åˆ›å»ºé¡¹ç›®"æŒ‰é’®
- **ä¸»ä½“åŒºåŸŸ**ï¼šé¡¹ç›®åˆ—è¡¨è¡¨æ ¼

#### 2.3.2 ProjectTable ç»„ä»¶

**æ–‡ä»¶**ï¼š`apps/admin/app/dashboard/delivery/projects/components/ProjectTable.tsx`

```typescript
'use client';

import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import { MoreHorizontal, Eye, Edit, Trash2, Link as LinkIcon } from 'lucide-react';
import { Project } from '@/lib/api/projects';
import { useProjects } from '@/lib/features/projects/use-projects';
import { useDeleteProject } from '@/lib/features/projects/use-projects';
import { toast } from 'sonner';

export function ProjectTable() {
  const { data, isLoading, error } = useProjects();
  const deleteProject = useDeleteProject();

  const handleCopyLink = (viewerUrl: string) => {
    navigator.clipboard.writeText(viewerUrl);
    toast.success('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
  };

  const handleDelete = async (id: string, name: string) => {
    if (confirm(`ç¡®å®šè¦åˆ é™¤é¡¹ç›®"${name}"å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) {
      await deleteProject.mutateAsync(id);
      toast.success('é¡¹ç›®å·²åˆ é™¤');
    }
  };

  if (isLoading) {
    return <div className="text-center py-12">åŠ è½½ä¸­...</div>;
  }

  if (error) {
    return <div className="text-center py-12 text-destructive">åŠ è½½å¤±è´¥ï¼š{error.message}</div>;
  }

  if (!data || data.length === 0) {
    return (
      <div className="text-center py-12 border rounded-lg bg-muted/20">
        <p className="text-muted-foreground">æš‚æ— é¡¹ç›®</p>
        <p className="text-sm text-muted-foreground mt-2">ç‚¹å‡»å³ä¸Šè§’"åˆ›å»ºé¡¹ç›®"å¼€å§‹</p>
      </div>
    );
  }

  return (
    <div className="border rounded-lg">
      <Table>
        <TableHeader>
          <TableRow>
            <TableHead>é¡¹ç›®åç§°</TableHead>
            <TableHead>ç…§ç‰‡æ•°é‡</TableHead>
            <TableHead>çŠ¶æ€</TableHead>
            <TableHead>åˆ›å»ºæ—¶é—´</TableHead>
            <TableHead className="text-right">æ“ä½œ</TableHead>
          </TableRow>
        </TableHeader>
        <TableBody>
          {data.map((project) => (
            <TableRow key={project.id}>
              <TableCell className="font-medium">{project.name}</TableCell>
              <TableCell>{project.photoCount} å¼ </TableCell>
              <TableCell>
                <Badge
                  variant={
                    project.status === 'active'
                      ? 'default'
                      : project.status === 'submitted'
                      ? 'success'
                      : 'secondary'
                  }
                >
                  {getStatusText(project.status)}
                </Badge>
              </TableCell>
              <TableCell>
                {new Date(project.createdAt).toLocaleString('zh-CN')}
              </TableCell>
              <TableCell className="text-right">
                <DropdownMenu>
                  <DropdownMenuTrigger asChild>
                    <Button variant="ghost" size="icon">
                      <MoreHorizontal className="h-4 w-4" />
                    </Button>
                  </DropdownMenuTrigger>
                  <DropdownMenuContent align="end">
                    <DropdownMenuItem asChild>
                      <a href={`/dashboard/delivery/photos/${project.id}`}>
                        <Eye className="mr-2 h-4 w-4" />
                        æŸ¥çœ‹ç…§ç‰‡
                      </a>
                    </DropdownMenuItem>
                    <DropdownMenuItem>
                      <Edit className="mr-2 h-4 w-4" />
                      ç¼–è¾‘
                    </DropdownMenuItem>
                    <DropdownMenuItem onClick={() => handleCopyLink(project.viewerUrl)}>
                      <LinkIcon className="mr-2 h-4 w-4" />
                      å¤åˆ¶é“¾æ¥
                    </DropdownMenuItem>
                    <DropdownMenuItem
                      className="text-destructive"
                      onClick={() => handleDelete(project.id, project.name)}
                    >
                      <Trash2 className="mr-2 h-4 w-4" />
                      åˆ é™¤
                    </DropdownMenuItem>
                  </DropdownMenuContent>
                </DropdownMenu>
              </TableCell>
            </TableRow>
          ))}
        </TableBody>
      </Table>
    </div>
  );
}

function getStatusText(status: string): string {
  const statusMap: Record<string, string> = {
    active: 'æ´»è·ƒ',
    submitted: 'å·²æäº¤',
    expired: 'å·²è¿‡æœŸ',
    revoked: 'å·²æ’¤é”€',
  };
  return statusMap[status] || status;
}
```

**ç»„ä»¶ç‰¹æ€§**ï¼š

1. **åŠ è½½çŠ¶æ€**ï¼šæ˜¾ç¤º"åŠ è½½ä¸­..."
2. **é”™è¯¯çŠ¶æ€**ï¼šæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
3. **ç©ºçŠ¶æ€**ï¼šæç¤ºç”¨æˆ·åˆ›å»ºç¬¬ä¸€ä¸ªé¡¹ç›®
4. **æ•°æ®å±•ç¤º**ï¼šè¡¨æ ¼å½¢å¼ï¼Œæ”¯æŒæ’åºå’Œåˆ†é¡µ
5. **æ“ä½œèœå•**ï¼šæ¯ä¸ªé¡¹ç›®éƒ½æœ‰ä¸‹æ‹‰èœå•ï¼ŒåŒ…å«å¤šä¸ªæ“ä½œ

**çŠ¶æ€å¾½ç« **ï¼š

ä½¿ç”¨ä¸åŒçš„ Badge å˜ä½“åŒºåˆ†é¡¹ç›®çŠ¶æ€ï¼š

- `active`ï¼šé»˜è®¤ï¼ˆè“è‰²ï¼‰
- `submitted`ï¼šæˆåŠŸï¼ˆç»¿è‰²ï¼‰
- `expired`/`revoked`ï¼šæ¬¡è¦ï¼ˆç°è‰²ï¼‰

#### 2.3.3 CreateProjectButton ç»„ä»¶

**æ–‡ä»¶**ï¼š`apps/admin/app/dashboard/delivery/projects/components/CreateProjectButton.tsx`

```typescript
'use client';

import Link from 'next/link';
import { Plus } from 'lucide-react';
import { Button } from '@/components/ui/button';

export function CreateProjectButton() {
  return (
    <Link href="/dashboard/delivery/projects/new">
      <Button>
        <Plus className="mr-2 h-4 w-4" />
        åˆ›å»ºé¡¹ç›®
      </Button>
    </Link>
  );
}
```

**ç®€å•çš„è®¾è®¡**ï¼šä½¿ç”¨ Next.js çš„ `Link` ç»„ä»¶å®ç°å®¢æˆ·ç«¯å¯¼èˆªï¼Œæ— éœ€é¡µé¢åˆ·æ–°ã€‚

---

### 2.4 åˆ›å»ºé¡¹ç›®é¡µ

#### 2.4.1 é¡µé¢ç»„ä»¶

**æ–‡ä»¶**ï¼š`apps/admin/app/dashboard/delivery/projects/new/page.tsx`

```typescript
import Link from 'next/link';
import { ArrowLeft } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { CreateProjectForm } from '../components/CreateProjectForm';

export default function NewProjectPage() {
  return (
    <div className="space-y-6">
      {/* é¢åŒ…å±‘å¯¼èˆª */}
      <div className="flex items-center gap-4">
        <Link href="/dashboard/delivery/projects">
          <Button variant="ghost" size="icon">
            <ArrowLeft className="h-4 w-4" />
          </Button>
        </Link>
        <div>
          <h1 className="text-3xl font-bold tracking-tight">åˆ›å»ºé¡¹ç›®</h1>
          <p className="text-muted-foreground mt-2">
            å¡«å†™é¡¹ç›®ä¿¡æ¯å¹¶ç”Ÿæˆé€‰ç‰‡é“¾æ¥
          </p>
        </div>
      </div>

      {/* åˆ›å»ºè¡¨å• */}
      <CreateProjectForm />
    </div>
  );
}
```

#### 2.4.2 CreateProjectForm ç»„ä»¶

**æ–‡ä»¶**ï¼š`apps/admin/app/dashboard/delivery/projects/components/CreateProjectForm.tsx`

```typescript
'use client';

import { useRouter } from 'next/navigation';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import * as z from 'zod';
import { Button } from '@/components/ui/button';
import {
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { useCreateProject } from '@/lib/features/projects/use-projects';
import { Card, CardContent } from '@/components/ui/card';

// è¡¨å•éªŒè¯ Schema
const formSchema = z.object({
  name: z.string().min(1, 'é¡¹ç›®åç§°ä¸èƒ½ä¸ºç©º').max(256, 'é¡¹ç›®åç§°ä¸èƒ½è¶…è¿‡256ä¸ªå­—ç¬¦'),
  description: z.string().optional(),
  expiresAt: z.number().optional(),
});

type FormValues = z.infer<typeof formSchema>;

export function CreateProjectForm() {
  const router = useRouter();
  const createProject = useCreateProject();
  const form = useForm<FormValues>({
    resolver: zodResolver(formSchema),
    defaultValues: {
      name: '',
      description: '',
    },
  });

  const onSubmit = async (values: FormValues) => {
    try {
      await createProject.mutateAsync(values);
      router.push('/dashboard/delivery/projects');
    } catch (error) {
      // é”™è¯¯å·²åœ¨ useCreateProject ä¸­å¤„ç†
    }
  };

  return (
    <Card>
      <CardContent className="pt-6">
        <Form {...form}>
          <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6 max-w-2xl">
            {/* é¡¹ç›®åç§° */}
            <FormField
              control={form.control}
              name="name"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>é¡¹ç›®åç§° *</FormLabel>
                  <FormControl>
                    <Input placeholder="ä¾‹å¦‚ï¼šæå››å©šçº±ç…§é€‰ç‰‡" {...field} />
                  </FormControl>
                  <FormDescription>
                    ä¸ºé¡¹ç›®èµ·ä¸€ä¸ªæ˜“äºè¯†åˆ«çš„åç§°
                  </FormDescription>
                  <FormMessage />
                </FormItem>
              )}
            />

            {/* é¡¹ç›®æè¿° */}
            <FormField
              control={form.control}
              name="description"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>é¡¹ç›®æè¿°</FormLabel>
                  <FormControl>
                    <Textarea
                      placeholder="æ‹æ‘„æ—¶é—´ã€åœ°ç‚¹ç­‰ä¿¡æ¯..."
                      rows={4}
                      {...field}
                    />
                  </FormControl>
                  <FormDescription>
                    å¯é€‰ï¼šæä¾›æ›´å¤šé¡¹ç›®è¯¦æƒ…
                  </FormDescription>
                  <FormMessage />
                </FormItem>
              )}
            />

            {/* æäº¤æŒ‰é’® */}
            <div className="flex gap-4">
              <Button type="submit" disabled={createProject.isPending}>
                {createProject.isPending ? 'åˆ›å»ºä¸­...' : 'åˆ›å»ºé¡¹ç›®'}
              </Button>
              <Button
                type="button"
                variant="outline"
                onClick={() => router.back()}
                disabled={createProject.isPending}
              >
                å–æ¶ˆ
              </Button>
            </div>
          </form>
        </Form>
      </CardContent>
    </Card>
  );
}
```

**è¡¨å•éªŒè¯**ï¼š

ä½¿ç”¨ **zod** å®šä¹‰éªŒè¯è§„åˆ™ï¼š

- `name`ï¼šå¿…å¡«ï¼Œ1-256 ä¸ªå­—ç¬¦
- `description`ï¼šå¯é€‰
- `expiresAt`ï¼šå¯é€‰ï¼ˆé¢„ç•™å­—æ®µï¼‰

**ç”¨æˆ·ä½“éªŒ**ï¼š

1. **å®æ—¶éªŒè¯**ï¼šç”¨æˆ·è¾“å…¥æ—¶ç«‹å³æ˜¾ç¤ºé”™è¯¯
2. **æäº¤çŠ¶æ€**ï¼šæŒ‰é’®æ˜¾ç¤º"åˆ›å»ºä¸­..."å¹¶ç¦ç”¨
3. **é”™è¯¯æç¤º**ï¼šéªŒè¯å¤±è´¥æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯æ¶ˆæ¯
4. **å–æ¶ˆæ“ä½œ**ï¼šè¿”å›ä¸Šä¸€é¡µ

---

### 2.5 ç…§ç‰‡åˆ—è¡¨é¡µ

#### 2.5.1 é¡µé¢ç»„ä»¶

**æ–‡ä»¶**ï¼š`apps/admin/app/dashboard/delivery/photos/[projectId]/page.tsx`

```typescript
import { PhotoGrid } from './components/PhotoGrid';
import { PhotoUploadButton } from './components/PhotoUploadButton';

export default function PhotosListPage({
  params,
}: {
  params: { projectId: string };
}) {
  return (
    <div className="space-y-6">
      {/* é¡µé¢æ ‡é¢˜ */}
      <div className="flex justify-between items-center">
        <div>
          <h1 className="text-3xl font-bold tracking-tight">é¡¹ç›®ç…§ç‰‡</h1>
          <p className="text-muted-foreground mt-2">
            ç®¡ç†é¡¹ç›®ç…§ç‰‡å’Œä¸Šä¼ 
          </p>
        </div>
        <PhotoUploadButton projectId={params.projectId} />
      </div>

      {/* ç…§ç‰‡ç½‘æ ¼ */}
      <PhotoGrid projectId={params.projectId} />
    </div>
  );
}
```

**åŠ¨æ€è·¯ç”±**ï¼šä½¿ç”¨ `[projectId]` ä½œä¸ºåŠ¨æ€å‚æ•°ï¼Œä» `params` ä¸­è·å–ã€‚

#### 2.5.2 PhotoGrid ç»„ä»¶

**æ–‡ä»¶**ï¼š`apps/admin/app/dashboard/delivery/photos/[projectId]/components/PhotoGrid.tsx`

```typescript
'use client';

import Image from 'next/image';
import { Photo } from '@/lib/api/projects';
import { usePhotos } from '@/lib/features/projects/use-photos';

interface PhotoGridProps {
  projectId: string;
}

export function PhotoGrid({ projectId }: PhotoGridProps) {
  const { data, isLoading, error } = usePhotos(projectId);

  if (isLoading) {
    return <div className="text-center py-12">åŠ è½½ä¸­...</div>;
  }

  if (error) {
    return <div className="text-center py-12 text-destructive">åŠ è½½å¤±è´¥ï¼š{error.message}</div>;
  }

  if (!data || data.length === 0) {
    return (
      <div className="text-center py-12 border rounded-lg bg-muted/20">
        <p className="text-muted-foreground">æš‚æ— ç…§ç‰‡</p>
        <p className="text-sm text-muted-foreground mt-2">ç‚¹å‡»å³ä¸Šè§’"ä¸Šä¼ ç…§ç‰‡"å¼€å§‹</p>
      </div>
    );
  }

  return (
    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
      {data.map((photo) => (
        <PhotoCard key={photo.id} photo={photo} />
      ))}
    </div>
  );
}

function PhotoCard({ photo }: { photo: Photo }) {
  const imageUrl = `${process.env.NEXT_PUBLIC_R2_PUBLIC_URL}/${photo.previewKey}`;

  return (
    <div className="relative aspect-square group overflow-hidden rounded-lg border">
      {/* ç…§ç‰‡ */}
      <Image
        src={imageUrl}
        alt={photo.filename}
        fill
        className="object-cover"
        sizes="(max-width: 768px) 50vw, (max-width: 1200px) 33vw, 20vw"
      />

      {/* æ‚¬åœé®ç½© */}
      <div className="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity">
        <div className="absolute inset-0 flex items-center justify-center gap-2">
          <Button variant="secondary" size="sm" asChild>
            <a href={imageUrl} target="_blank" rel="noopener noreferrer">
              æŸ¥çœ‹
            </a>
          </Button>
          <Button variant="destructive" size="sm">
            åˆ é™¤
          </Button>
        </div>
      </div>

      {/* æ–‡ä»¶å */}
      <div className="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-2">
        <p className="text-white text-xs truncate">{photo.filename}</p>
      </div>
    </div>
  );
}
```

**ç½‘æ ¼å¸ƒå±€**ï¼š

ä½¿ç”¨ Tailwind CSS çš„ `grid` ç±»å®ç°å“åº”å¼ç½‘æ ¼ï¼š

- æ‰‹æœºç«¯ï¼š2 åˆ—
- å¹³æ¿ï¼š3 åˆ—
- æ¡Œé¢ï¼š4 åˆ—
- å¤§å±ï¼š5 åˆ—

**äº¤äº’è®¾è®¡**ï¼š

1. **æ‚¬åœæ•ˆæœ**ï¼šé¼ æ ‡æ‚¬åœæ˜¾ç¤ºæ“ä½œæŒ‰é’®
2. **å›¾ç‰‡æ‡’åŠ è½½**ï¼šNext.js `Image` ç»„ä»¶è‡ªåŠ¨ä¼˜åŒ–
3. **æ–‡ä»¶åæ˜¾ç¤º**ï¼šåº•éƒ¨æ¸å˜é®ç½©æ˜¾ç¤ºæ–‡ä»¶å

#### 2.5.3 PhotoUploadButton ç»„ä»¶

**æ–‡ä»¶**ï¼š`apps/admin/app/dashboard/delivery/photos/[projectId]/components/PhotoUploadButton.tsx`

```typescript
'use client';

import { useState } from 'react';
import { Upload } from 'lucide-react';
import { Button } from '@/components/ui/button';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from '@/components/ui/dialog';
import { AssetUpload } from '@/components/features/upload/asset-upload';

interface PhotoUploadButtonProps {
  projectId: string;
}

export function PhotoUploadButton({ projectId }: PhotoUploadButtonProps) {
  const [open, setOpen] = useState(false);

  const handleSuccess = () => {
    setOpen(false);
    // React Query ä¼šè‡ªåŠ¨é‡æ–°è·å–æ•°æ®
  };

  return (
    <Dialog open={open} onOpenChange={setOpen}>
      <DialogTrigger asChild>
        <Button>
          <Upload className="mr-2 h-4 w-4" />
          ä¸Šä¼ ç…§ç‰‡
        </Button>
      </DialogTrigger>
      <DialogContent className="max-w-2xl">
        <DialogHeader>
          <DialogTitle>ä¸Šä¼ ç…§ç‰‡åˆ°é¡¹ç›®</DialogTitle>
        </DialogHeader>
        <AssetUpload
          projectId={projectId}
          onSuccess={handleSuccess}
        />
      </DialogContent>
    </Dialog>
  );
}
```

**è®¾è®¡è¯´æ˜**ï¼š

- **å¯¹è¯æ¡†**ï¼šä½¿ç”¨ Dialog ç»„ä»¶ï¼Œä¸ç¦»å¼€å½“å‰é¡µé¢
- **AssetUpload**ï¼šå¤ç”¨ç°æœ‰ä¸Šä¼ ç»„ä»¶ï¼ˆå‡è®¾å·²å®ç°ï¼‰
- **å…³é—­æ—¶æœº**ï¼šä¸Šä¼ æˆåŠŸåè‡ªåŠ¨å…³é—­
- **è‡ªåŠ¨åˆ·æ–°**ï¼šReact Query çš„ç¼“å­˜å¤±æ•ˆä¼šè§¦å‘é‡æ–°è·å–

---

### 2.6 React Query Hooks

#### 2.6.1 é¡¹ç›®ç›¸å…³ Hooks

**æ–‡ä»¶**ï¼š`apps/admin/lib/features/projects/use-projects.ts`

```typescript
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { projectsApi, Project, CreateProjectDto, UpdateProjectDto } from '@/lib/api/projects';
import { toast } from 'sonner';

/**
 * è·å–é¡¹ç›®åˆ—è¡¨
 */
export function useProjects(params?: any) {
  return useQuery({
    queryKey: ['projects', params],
    queryFn: () => projectsApi.findAll(params),
  });
}

/**
 * åˆ›å»ºé¡¹ç›®
 */
export function useCreateProject() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: (data: CreateProjectDto) => projectsApi.create(data),
    onSuccess: (project) => {
      // å¤±æ•ˆé¡¹ç›®åˆ—è¡¨æŸ¥è¯¢
      queryClient.invalidateQueries({ queryKey: ['projects'] });
      toast.success(`é¡¹ç›®"${project.name}"å·²åˆ›å»º`);
    },
  });
}

/**
 * æ›´æ–°é¡¹ç›®
 */
export function useUpdateProject() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: ({ id, data }: { id: string; data: UpdateProjectDto }) =>
      projectsApi.update(id, data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['projects'] });
      toast.success('é¡¹ç›®å·²æ›´æ–°');
    },
  });
}

/**
 * åˆ é™¤é¡¹ç›®
 */
export function useDeleteProject() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: (id: string) => projectsApi.remove(id),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['projects'] });
    },
    // ä¸æ˜¾ç¤º toastï¼Œå› ä¸ºç»„ä»¶ä¸­å·²ç»å¤„ç†äº†
  });
}
```

**Query Key è®¾è®¡**ï¼š

ä½¿ç”¨æ•°ç»„å½¢å¼çš„ query keyï¼Œä¾¿äºç²¾ç¡®å¤±æ•ˆï¼š

- `['projects']`ï¼šæ‰€æœ‰é¡¹ç›®
- `['projects', params]`ï¼šå¸¦å‚æ•°çš„é¡¹ç›®åˆ—è¡¨
- `['project', id]`ï¼šå•ä¸ªé¡¹ç›®

**Mutation å›è°ƒ**ï¼š

- **onSuccess**ï¼šæ“ä½œæˆåŠŸå
  - å¤±æ•ˆç›¸å…³æŸ¥è¯¢ï¼ˆ`invalidateQueries`ï¼‰
  - æ˜¾ç¤ºæˆåŠŸæç¤ºï¼ˆ`toast.success`ï¼‰
- **onError**ï¼šæ“ä½œå¤±è´¥æ—¶ï¼ˆå¯é€‰ï¼‰
  - æ˜¾ç¤ºé”™è¯¯æç¤ºï¼ˆ`apiClient` å·²å…¨å±€å¤„ç†ï¼‰

#### 2.6.2 ç…§ç‰‡ç›¸å…³ Hooks

**æ–‡ä»¶**ï¼š`apps/admin/lib/features/projects/use-photos.ts`

```typescript
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { projectsApi, Photo } from '@/lib/api/projects';
import { toast } from 'sonner';

/**
 * è·å–é¡¹ç›®ç…§ç‰‡åˆ—è¡¨
 */
export function usePhotos(projectId: string) {
  return useQuery({
    queryKey: ['photos', projectId],
    queryFn: () => projectsApi.findPhotos(projectId),
    enabled: !!projectId, // åªæœ‰ projectId å­˜åœ¨æ—¶æ‰æŸ¥è¯¢
  });
}

/**
 * åˆ é™¤ç…§ç‰‡
 */
export function useDeletePhotos() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: ({ projectId, photoIds }: { projectId: string; photoIds: string[] }) =>
      projectsApi.removePhotos(projectId, photoIds),
    onSuccess: (_, variables) => {
      queryClient.invalidateQueries({ queryKey: ['photos', variables.projectId] });
      queryClient.invalidateQueries({ queryKey: ['projects'] }); // æ›´æ–° photoCount
      toast.success(`å·²åˆ é™¤${variables.photoIds.length}å¼ ç…§ç‰‡`);
    },
  });
}
```

**æ¡ä»¶æŸ¥è¯¢**ï¼š

`enabled: !!projectId` ç¡®ä¿åªåœ¨ `projectId` å­˜åœ¨æ—¶æ‰å‘èµ·æŸ¥è¯¢ã€‚

**è”åŠ¨æ›´æ–°**ï¼š

åˆ é™¤ç…§ç‰‡åï¼ŒåŒæ—¶å¤±æ•ˆï¼š

- `['photos', projectId]`ï¼šç…§ç‰‡åˆ—è¡¨
- `['projects']`ï¼šé¡¹ç›®åˆ—è¡¨ï¼ˆæ›´æ–° `photoCount`ï¼‰

---

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šå®è·µç¤ºä¾‹

### 3.1 å®Œæ•´çš„é¡¹ç›®åˆ›å»ºæµç¨‹

**åœºæ™¯**ï¼šç®¡ç†å‘˜åˆ›å»ºä¸€ä¸ª"æå››å©šçº±ç…§é€‰ç‰‡"é¡¹ç›®

**æ­¥éª¤ 1ï¼šæ‰“å¼€åˆ›å»ºé¡µé¢**

```
ç”¨æˆ·æ“ä½œï¼šç‚¹å‡»"åˆ›å»ºé¡¹ç›®"æŒ‰é’®
ç³»ç»Ÿå“åº”ï¼šè·³è½¬åˆ° /dashboard/delivery/projects/new
```

**æ­¥éª¤ 2ï¼šå¡«å†™è¡¨å•**

```typescript
// ç”¨æˆ·è¾“å…¥
{
  name: "æå››å©šçº±ç…§é€‰ç‰‡",
  description: "2024å¹´1æœˆ1æ—¥æ‹æ‘„ï¼Œå®¤å¤–åœºæ™¯"
}

// è¡¨å•éªŒè¯ï¼ˆå®æ—¶ï¼‰
âœ… name: éç©ºï¼Œé•¿åº¦1-256
âœ… description: å¯é€‰
```

**æ­¥éª¤ 3ï¼šæäº¤è¡¨å•**

```typescript
// å‰ç«¯è°ƒç”¨
const project = await createProject.mutateAsync({
  name: "æå››å©šçº±ç…§é€‰ç‰‡",
  description: "2024å¹´1æœˆ1æ—¥æ‹æ‘„ï¼Œå®¤å¤–åœºæ™¯"
});

// åç«¯å“åº”
{
  id: "set_V1StGXR8_Z5jdHi6B-myT",
  name: "æå››å©šçº±ç…§é€‰ç‰‡",
  description: "2024å¹´1æœˆ1æ—¥æ‹æ‘„ï¼Œå®¤å¤–åœºæ™¯",
  token: "V1StGXR8_Z5jdHi6B-myT8LIM1q",
  viewerUrl: "http://localhost:3000/viewer/V1StGXR8_Z5jdHi6B-myT8LIM1q",
  status: "active",
  photoCount: 0,
  createdAt: 1704067200000,
  updatedAt: 1704067200000
}
```

**æ­¥éª¤ 4ï¼šè‡ªåŠ¨è·³è½¬**

```
ç³»ç»Ÿå“åº”ï¼š
1. æ˜¾ç¤ºæˆåŠŸæç¤ºï¼š"é¡¹ç›®"æå››å©šçº±ç…§é€‰ç‰‡"å·²åˆ›å»º"
2. è·³è½¬å›åˆ—è¡¨é¡µï¼š/dashboard/delivery/projects
3. åˆ·æ–°é¡¹ç›®åˆ—è¡¨ï¼ˆReact Query è‡ªåŠ¨å¤±æ•ˆç¼“å­˜ï¼‰
```

**æ•°æ®æµ**ï¼š

```mermaid
sequenceDiagram
    participant ç”¨æˆ·
    participant CreateProjectForm
    participant useCreateProject
    participant projectsApi
    participant åç«¯API
    participant ReactQuery

    ç”¨æˆ·->>CreateProjectForm: å¡«å†™è¡¨å•å¹¶æäº¤
    CreateProjectForm->>useCreateProject: mutateAsync(values)
    useCreateProject->>projectsApi: create(data)
    projectsApi->>åç«¯API: POST /api/projects
    åç«¯API-->>projectsApi: è¿”å›é¡¹ç›®å¯¹è±¡
    projectsApi-->>useCreateProject: project
    useCreateProject->>ReactQuery: invalidateQueries(['projects'])
    useCreateProject-->>CreateProjectForm: onSuccesså›è°ƒ
    CreateProjectForm->>ç”¨æˆ·: æ˜¾ç¤ºæˆåŠŸæç¤º + è·³è½¬
```

### 3.2 ç…§ç‰‡ä¸Šä¼ ä¸ç¡®è®¤æµç¨‹

**åœºæ™¯**ï¼šç®¡ç†å‘˜ä¸Šä¼  10 å¼ ç…§ç‰‡åˆ°é¡¹ç›®

**æ­¥éª¤ 1ï¼šæ‰“å¼€ä¸Šä¼ å¯¹è¯æ¡†**

```
ç”¨æˆ·æ“ä½œï¼šåœ¨ç…§ç‰‡åˆ—è¡¨é¡µç‚¹å‡»"ä¸Šä¼ ç…§ç‰‡"æŒ‰é’®
ç³»ç»Ÿå“åº”ï¼šæ‰“å¼€ Dialogï¼Œæ˜¾ç¤º AssetUpload ç»„ä»¶
```

**æ­¥éª¤ 2ï¼šé€‰æ‹©æ–‡ä»¶**

```typescript
// ç”¨æˆ·é€‰æ‹© 10 å¼ ç…§ç‰‡
const files = [
  File { name: "IMG_001.jpg", size: 5242880, type: "image/jpeg" },
  File { name: "IMG_002.jpg", size: 5120000, type: "image/jpeg" },
  // ... å…± 10 å¼ 
];

// å‰ç«¯éªŒè¯
âœ… æ–‡ä»¶ç±»å‹ï¼šimage/jpeg, image/png
âœ… æ–‡ä»¶å¤§å°ï¼š< 20MB
âœ… æ•°é‡ï¼šæ— é™åˆ¶
```

**æ­¥éª¤ 3ï¼šè·å–ä¸Šä¼ ç­¾åå¹¶ä¸Šä¼ **

```typescript
// å¯¹æ¯å¼ ç…§ç‰‡æ‰§è¡Œ
for (const file of files) {
  // 1. è·å–ç­¾å
  const { uploadUrl, objectKey } = await assetsApi.sign({
    purpose: 'photo_original',
    filename: file.name,
    contentType: file.type,
    size: file.size,
    projectId: 'set_V1StGXR8_Z5jdHi6B-myT',
  });

  // 2. ç›´ä¼  R2
  await fetch(uploadUrl, {
    method: 'PUT',
    body: file,
    headers: { 'Content-Type': file.type },
  });

  // 3. ç¡®è®¤ä¸Šä¼ 
  await assetsApi.confirmPhotos({
    projectId: 'set_V1StGXR8_Z5jdHi6B-myT',
    photos: [
      {
        filename: file.name,
        originalKey: objectKey,
        previewKey: objectKey.replace('original', 'preview'),
        thumbKey: objectKey.replace('original', 'thumb'),
        fileSize: file.size,
      },
    ],
  });
}
```

**æ­¥éª¤ 4ï¼šæ›´æ–°ç•Œé¢**

```
ç³»ç»Ÿå“åº”ï¼š
1. æ˜¾ç¤ºä¸Šä¼ è¿›åº¦ï¼ˆ0% â†’ 100%ï¼‰
2. ä¸Šä¼ å®Œæˆåæ˜¾ç¤ºï¼š"å·²ä¸Šä¼ 10å¼ ç…§ç‰‡"
3. å…³é—­å¯¹è¯æ¡†
4. åˆ·æ–°ç…§ç‰‡ç½‘æ ¼ï¼ˆReact Query è‡ªåŠ¨å¤±æ•ˆç¼“å­˜ï¼‰
5. æ›´æ–°é¡¹ç›®çš„ photoCountï¼ˆåˆ—è¡¨é¡µåŒæ­¥æ›´æ–°ï¼‰
```

**æ•°æ®æµ**ï¼š

```mermaid
sequenceDiagram
    participant ç”¨æˆ·
    participant AssetUpload
    participant assetsApi
    participant R2å­˜å‚¨
    participant åç«¯API
    participant ReactQuery

    ç”¨æˆ·->>AssetUpload: é€‰æ‹©10å¼ ç…§ç‰‡
    AssetUpload->>assetsApi: sign() è·å–ç­¾å
    assetsApi->>åç«¯API: POST /api/assets/sign
    åç«¯API-->>assetsApi: { uploadUrl, objectKey }
    assetsApi-->>AssetUpload: ç­¾åä¿¡æ¯

    loop æ¯å¼ ç…§ç‰‡
        AssetUpload->>R2å­˜å‚¨: PUT uploadUrl (ç›´ä¼ )
        R2å­˜å‚¨-->>AssetUpload: ä¸Šä¼ æˆåŠŸ
    end

    AssetUpload->>assetsApi: confirmPhotos()
    assetsApi->>åç«¯API: POST /api/assets/photos/confirm
    åç«¯API->>åç«¯API: åˆ›å»ºPhotoè®°å½•
    åç«¯API->>åç«¯API: æ›´æ–°photoCount
    åç«¯API-->>assetsApi: { confirmed: 10 }
    assetsApi-->>AssetUpload: ç¡®è®¤æˆåŠŸ

    AssetUpload->>ReactQuery: invalidateQueries
    ReactQuery-->>ç”¨æˆ·: åˆ·æ–°ç…§ç‰‡ç½‘æ ¼
```

### 3.3 å®¢æˆ·é“¾æ¥ç”Ÿæˆä¸åˆ†äº«

**åœºæ™¯**ï¼šç®¡ç†å‘˜å¤åˆ¶é€‰ç‰‡é“¾æ¥å‘é€ç»™å®¢æˆ·

**æ­¥éª¤ 1ï¼šæŸ¥çœ‹é¡¹ç›®åˆ—è¡¨**

```
ç”¨æˆ·æ“ä½œï¼šæ‰“å¼€é¡¹ç›®åˆ—è¡¨é¡µ
ç•Œé¢å±•ç¤ºï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é¡¹ç›®åç§°        ç…§ç‰‡æ•°é‡  çŠ¶æ€    åˆ›å»ºæ—¶é—´    æ“ä½œ   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æå››å©šçº±ç…§é€‰ç‰‡   10å¼      æ´»è·ƒ    2024-01-01  â‹¯    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ­¥éª¤ 2ï¼šå¤åˆ¶é“¾æ¥**

```typescript
// ç”¨æˆ·ç‚¹å‡»"å¤åˆ¶é“¾æ¥"èœå•é¡¹
const handleCopyLink = (viewerUrl: string) => {
  navigator.clipboard.writeText(viewerUrl);
  toast.success('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
};

// å¤åˆ¶çš„é“¾æ¥
viewerUrl: 'http://localhost:3000/viewer/V1StGXR8_Z5jdHi6B-myT8LIM1q';
```

**æ­¥éª¤ 3ï¼šå‘é€ç»™å®¢æˆ·**

```
ç®¡ç†å‘˜æ“ä½œï¼š
1. æ‰“å¼€å¾®ä¿¡/é‚®ä»¶/çŸ­ä¿¡
2. ç²˜è´´é“¾æ¥
3. å‘é€ç»™å®¢æˆ·

å®¢æˆ·æ¥æ”¶ï¼š
"æ‚¨å¥½ï¼Œè¿™æ˜¯æ‚¨çš„é€‰ç‰‡é“¾æ¥ï¼š
http://localhost:3000/viewer/V1StGXR8_Z5jdHi6B-myT8LIM1q
è¯·åœ¨7å¤©å†…å®Œæˆé€‰ç‰‡ã€‚"
```

**å®‰å…¨è¯´æ˜**ï¼š

- **Token é•¿åº¦**ï¼š32 ä½éšæœºå­—ç¬¦ï¼Œæ— æ³•çŒœæµ‹
- **è¿‡æœŸæ—¶é—´**ï¼šåˆ›å»ºé¡¹ç›®æ—¶å¯è®¾ç½®ï¼ˆå¦‚ 7 å¤©åè¿‡æœŸï¼‰
- **æ’¤é”€æœºåˆ¶**ï¼šç®¡ç†å‘˜å¯ä»¥éšæ—¶æ’¤é”€é¡¹ç›®é“¾æ¥

---

## ç¬¬å››éƒ¨åˆ†ï¼šæ€»ç»“ä¸æœ€ä½³å®è·µ

### 4.1 ç»„ä»¶è®¾è®¡åŸåˆ™

#### å•ä¸€èŒè´£

æ¯ä¸ªç»„ä»¶åªåšä¸€ä»¶äº‹ï¼š

```typescript
// âœ… å¥½çš„è®¾è®¡
<ProjectTable />      // åªè´Ÿè´£å±•ç¤ºè¡¨æ ¼
<CreateProjectForm /> // åªè´Ÿè´£è¡¨å•æäº¤
<PhotoGrid />         // åªè´Ÿè´£ç…§ç‰‡ç½‘æ ¼

// âŒ ä¸å¥½çš„è®¾è®¡
<ProjectManagement /> // åŒ…å«åˆ—è¡¨ã€è¡¨å•ã€ä¸Šä¼ ç­‰æ‰€æœ‰åŠŸèƒ½
```

#### ç»„ä»¶å¤ç”¨

é€šè¿‡ props ä¼ é€’é…ç½®ï¼Œè€Œä¸æ˜¯å¤åˆ¶ç»„ä»¶ï¼š

```typescript
// âœ… å¥½çš„è®¾è®¡
<PhotoCard photo={photo} variant="grid" />
<PhotoCard photo={photo} variant="list" />

// âŒ ä¸å¥½çš„è®¾è®¡
<GridPhotoCard photo={photo} />
<ListPhotoCard photo={photo} />
```

#### ç»„ä»¶ç»„åˆ

ç»„åˆå°ç»„ä»¶æ„å»ºå¤§ç»„ä»¶ï¼š

```typescript
// å¥½çš„è®¾è®¡
<ProjectsListPage>
  <PageHeader />
  <ProjectTable />
</ProjectsListPage>

// è€Œä¸æ˜¯ä¸€ä¸ªå·¨å¤§çš„ç»„ä»¶
function ProjectsListPage() {
  return (
    // 500 è¡Œä»£ç 
  );
}
```

### 4.2 çŠ¶æ€ç®¡ç†æœ€ä½³å®è·µ

#### æœåŠ¡å™¨çŠ¶æ€ vs å®¢æˆ·ç«¯çŠ¶æ€

**æœåŠ¡å™¨çŠ¶æ€**ï¼ˆä½¿ç”¨ React Queryï¼‰ï¼š

- ä» API è·å–çš„æ•°æ®
- éœ€è¦ç¼“å­˜å’Œå¤±æ•ˆ
- éœ€è¦åŠ è½½ã€é”™è¯¯çŠ¶æ€
- éœ€è¦è‡ªåŠ¨é‡æ–°è·å–

**å®¢æˆ·ç«¯çŠ¶æ€**ï¼ˆä½¿ç”¨ useStateï¼‰ï¼š

- UI çŠ¶æ€ï¼ˆå¯¹è¯æ¡†å¼€å…³ã€é€‰é¡¹å¡ç­‰ï¼‰
- è¡¨å•è¾“å…¥
- ä¸éœ€è¦æŒä¹…åŒ–çš„æ•°æ®

```typescript
// âœ… å¥½çš„åˆ’åˆ†
const { data: projects } = useProjects(); // æœåŠ¡å™¨çŠ¶æ€
const [dialogOpen, setDialogOpen] = useState(false); // å®¢æˆ·ç«¯çŠ¶æ€
const form = useForm(); // è¡¨å•çŠ¶æ€ï¼ˆreact-hook-form å†…éƒ¨ç®¡ç†ï¼‰

// âŒ ä¸å¥½çš„åˆ’åˆ†
const [projects, setProjects] = useState([]); // åº”è¯¥ç”¨ React Query
const [isProjectActive] = useState(true); // ç®€å•å¸ƒå°”å€¼ï¼Œä¸éœ€è¦å¤æ‚çŠ¶æ€ç®¡ç†
```

#### Query Key è®¾è®¡

ä½¿ç”¨ç»“æ„åŒ–çš„ query keyï¼š

```typescript
// âœ… å¥½çš„è®¾è®¡
queryKey: ['projects', { status: 'active', page: 1 }];
queryKey: ['project', 'set_abc123'];
queryKey: ['photos', 'set_abc123'];

// âŒ ä¸å¥½çš„è®¾è®¡
queryKey: 'projects'; // å­—ç¬¦ä¸²å½¢å¼ï¼Œä¸ä¾¿ç®¡ç†
queryKey: ['projects', 'set_abc123', 'photos']; // åµŒå¥—è¿‡æ·±
```

#### ç¼“å­˜å¤±æ•ˆç­–ç•¥

ç²¾å‡†å¤±æ•ˆç›¸å…³æŸ¥è¯¢ï¼š

```typescript
// åˆ›å»ºé¡¹ç›®å
queryClient.invalidateQueries({ queryKey: ['projects'] });

// åˆ é™¤ç…§ç‰‡å
queryClient.invalidateQueries({ queryKey: ['photos', projectId] });
queryClient.invalidateQueries({ queryKey: ['projects'] }); // æ›´æ–° photoCount

// âŒ é¿å…å¤±æ•ˆæ‰€æœ‰æŸ¥è¯¢
queryClient.invalidateQueries(); // å¤ªæš´åŠ›
```

### 4.3 ç”¨æˆ·ä½“éªŒä¼˜åŒ–

#### åŠ è½½çŠ¶æ€

**éª¨æ¶å±**æ¯”"åŠ è½½ä¸­..."æ–‡å­—æ›´å‹å¥½ï¼š

```typescript
// âœ… å¥½çš„è®¾è®¡
if (isLoading) {
  return <TableSkeleton />;
}

// âš ï¸ å¯æ¥å—
if (isLoading) {
  return <div>åŠ è½½ä¸­...</div>;
}

// âŒ ä¸å¥½çš„è®¾è®¡
if (isLoading) {
  return null; // ç™½å±ï¼Œç”¨æˆ·ä¸çŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆ
}
```

#### é”™è¯¯å¤„ç†

åˆ†çº§å¤„ç†é”™è¯¯ï¼š

```typescript
// 1. å…¨å±€é”™è¯¯å¤„ç†ï¼ˆapiClientï¼‰
apiClient.interceptors.response.use(
  (response) => response,
  (error) => {
    const message = error.response?.data?.message || 'æ“ä½œå¤±è´¥';
    toast.error(message);
    return Promise.reject(error);
  }
);

// 2. ç»„ä»¶çº§é”™è¯¯å¤„ç†
if (error) {
  return <ErrorMessage error={error} />;
}

// 3. æ“ä½œçº§é”™è¯¯å¤„ç†
const handleDelete = async () => {
  try {
    await deleteProject.mutateAsync(id);
    toast.success('åˆ é™¤æˆåŠŸ');
  } catch (error) {
    // å·²ç”±å…¨å±€å¤„ç†ï¼Œç»„ä»¶ä¸­æ— éœ€é‡å¤
  }
};
```

#### æˆåŠŸåé¦ˆ

æ“ä½œæˆåŠŸåç»™äºˆæ˜ç¡®åé¦ˆï¼š

```typescript
// âœ… å¥½çš„è®¾è®¡
toast.success('é¡¹ç›®å·²åˆ›å»º');
toast.success(`å·²åˆ é™¤${photoIds.length}å¼ ç…§ç‰‡`);
toast.success('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');

// âŒ ä¸å¥½çš„è®¾è®¡
toast.success('æ“ä½œæˆåŠŸ'); // å¤ªæ¨¡ç³Š
```

#### æ€§èƒ½ä¼˜åŒ–

**å›¾ç‰‡æ‡’åŠ è½½**ï¼šä½¿ç”¨ Next.js `Image` ç»„ä»¶

```typescript
<Image
  src={photo.previewKey}
  alt={photo.filename}
  fill
  loading="lazy" // æ‡’åŠ è½½
  sizes="(max-width: 768px) 50vw, 20vw" // å“åº”å¼å°ºå¯¸
/>
```

**è™šæ‹Ÿæ»šåŠ¨**ï¼šå¤§é‡ç…§ç‰‡æ—¶ä½¿ç”¨ react-window

```typescript
import { FixedSizeGrid } from 'react-window';

<FixedSizeGrid
  columnCount={columns}
  columnWidth={200}
  height={600}
  rowCount={photos.length}
  rowHeight={200}
  width={800}
>
  {PhotoCard}
</FixedSizeGrid>
```

**è¯·æ±‚å»é‡**ï¼šReact Query è‡ªåŠ¨å»é‡ç›¸åŒè¯·æ±‚

```typescript
// å³ä½¿å¤šä¸ªç»„ä»¶åŒæ—¶è°ƒç”¨
const projects1 = useProjects();
const projects2 = useProjects();
// React Query åªä¼šå‘é€ä¸€ä¸ªè¯·æ±‚
```

### 4.4 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

#### é—®é¢˜1ï¼šè¡¨å•é‡ç½®åæäº¤æŒ‰é’®ä»ç¦ç”¨

**åŸå› **ï¼š`isPending` çŠ¶æ€æœªé‡ç½®

**è§£å†³**ï¼š

```typescript
const onSubmit = async (values) => {
  try {
    await createProject.mutateAsync(values);
    router.push('/dashboard/delivery/projects');
  } catch (error) {
    // é”™è¯¯å·²åœ¨ mutation ä¸­å¤„ç†
  } finally {
    // ä¸éœ€è¦é¢å¤–æ“ä½œï¼ŒReact Query ä¼šè‡ªåŠ¨é‡ç½® isPending
  }
};
```

#### é—®é¢˜2ï¼šåˆ é™¤ååˆ—è¡¨æœªæ›´æ–°

**åŸå› **ï¼šç¼“å­˜æœªå¤±æ•ˆ

**è§£å†³**ï¼š

```typescript
export function useDeleteProject() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: (id: string) => projectsApi.remove(id),
    onSuccess: () => {
      // å…³é”®ï¼šå¤±æ•ˆç¼“å­˜
      queryClient.invalidateQueries({ queryKey: ['projects'] });
    },
  });
}
```

#### é—®é¢˜3ï¼šå¯¹è¯æ¡†å…³é—­åæ•°æ®æœªåˆ·æ–°

**åŸå› **ï¼šæœªè§¦å‘æŸ¥è¯¢

**è§£å†³**ï¼š

```typescript
const handleSuccess = () => {
  setOpen(false); // å…³é—­å¯¹è¯æ¡†
  queryClient.invalidateQueries({ queryKey: ['photos', projectId] });
};
```

#### é—®é¢˜4ï¼šå›¾ç‰‡åŠ è½½å¤±è´¥

**åŸå› **ï¼šR2 URL é”™è¯¯æˆ–æƒé™é—®é¢˜

**è§£å†³**ï¼š

```typescript
<Image
  src={imageUrl}
  alt={photo.filename}
  fill
  onError={(e) => {
    // æ˜¾ç¤ºå ä½å›¾
    e.currentTarget.src = '/placeholder.png';
  }}
/>
```

#### é—®é¢˜5ï¼šåˆ†é¡µä¸å·¥ä½œ

**åŸå› **ï¼šæœªä¼ é€’åˆ†é¡µå‚æ•°

**è§£å†³**ï¼š

```typescript
export function useProjects(params?: QueryParams) {
  return useQuery({
    queryKey: ['projects', params],
    queryFn: () => projectsApi.findAll(params), // ä¼ é€’ params
  });
}

// ä½¿ç”¨æ—¶
const { data } = useProjects({ page: 1, limit: 20 });
```

---

## ğŸ† æ€»ç»“

é€šè¿‡æœ¬æ•™ç¨‹ï¼Œæˆ‘ä»¬å®Œæ•´å®ç°äº†é¡¹ç›®ç®¡ç†ç•Œé¢ï¼Œæ¶µç›–ï¼š

### æ ¸å¿ƒæˆæœ

âœ… **5 ä¸ªé¡µé¢/ç»„ä»¶**ï¼šåˆ—è¡¨é¡µã€åˆ›å»ºé¡µã€ç…§ç‰‡åˆ—è¡¨é¡µã€è¡¨æ ¼ã€è¡¨å•
âœ… **å®Œæ•´çš„ CRUD**ï¼šåˆ›å»ºã€è¯»å–ã€æ›´æ–°ã€åˆ é™¤é¡¹ç›®
âœ… **React Query é›†æˆ**ï¼šæœåŠ¡å™¨çŠ¶æ€ç®¡ç†ã€ç¼“å­˜ã€å¤±æ•ˆ
âœ… **è¡¨å•éªŒè¯**ï¼šreact-hook-form + zod
âœ… **ç”¨æˆ·ä½“éªŒä¼˜åŒ–**ï¼šåŠ è½½çŠ¶æ€ã€é”™è¯¯å¤„ç†ã€æˆåŠŸåé¦ˆ

### å…³é”®æŠ€èƒ½

- ğŸ¯ Next.js 13+ App Router ä½¿ç”¨
- ğŸ¯ React Query çŠ¶æ€ç®¡ç†
- ğŸ¯ shadcn/ui ç»„ä»¶ä½¿ç”¨
- ğŸ¯ TypeScript ç±»å‹å®‰å…¨
- ğŸ¯ è¡¨å•éªŒè¯ä¸é”™è¯¯å¤„ç†

### ä¸‹ä¸€æ­¥

1. **Viewer å‰ç«¯**ï¼šå‚è€ƒ [`docs/modules/photo-selection-mvp/04-viewer-ui.md`](../../modules/photo-selection-mvp/04-viewer-ui.md)
2. **æµ‹è¯•éªŒè¯**ï¼šå‚è€ƒ [`docs/modules/photo-selection-mvp/05-testing.md`](../../modules/photo-selection-mvp/05-testing.md)
3. **åŠŸèƒ½æ‰©å±•**ï¼šæ‰¹é‡æ“ä½œã€ç­›é€‰æ’åºã€å¯¼å…¥å¯¼å‡ºç­‰

---

**æœ€åæ›´æ–°**ï¼š2026-01-04
**ç»´æŠ¤è€…**ï¼šå¼€å‘å›¢é˜Ÿ
**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
