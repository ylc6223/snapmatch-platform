# Admin 上传方案（作品集素材 / 交付照片）——统一签名、分开入库

## 1. 背景

PRD 中多处出现“上传图片”，但在实现层面至少有两条完全不同的业务链路：

- **作品集素材**：用于小程序展示/营销内容（作品图、轮播图等）
- **交付照片**：用于客户选片/交付链路（项目原片、预览图/缩略图、精修交付图）

两者在权限、归档路径、后处理（如水印/多规格图）上差异很大，必须显式区分。

## 2. 目标

- 对齐术语：团队沟通时明确“上传的是哪一类”
- 降低后端重复建设成本：签名/STS、校验、风控、日志等通用能力不做两套
- 避免资产混用：作品集素材与交付照片在权限与存储归档策略上不互相污染

## 3. 推荐方案（核心结论）

### 3.1 一句话

**统一“拿上传通行证”（签名/STS），分开“登记入册”（确认/入库/绑定业务）。**

### 3.2 大白话版本（给团队快速对齐用）

1. **先拿“上传通行证”（签名/STS）**：检查你有没有登录、限制文件大小/类型，给你一个临时凭证让你把文件直接传到云存储。两类上传这一步都一样，所以只做一个 `POST /assets/sign`，请求里带 `purpose=作品集素材/交付照片`。

2. **上传完再“登记入册”（确认/入库/绑定业务）**：文件传完只是“云上有个文件”，系统还不知道它属于哪个作品/哪个项目、要不要加水印，所以这一步按业务分开：

- 交付照片走 `POST /photos/confirm`（绑定项目/相册，触发水印/缩略图处理）
- 作品集素材走 `POST /works/:id/assets/confirm`（绑定到某个作品/轮播图配置）

## 4. 接口约定（建议）

### 4.1 统一签名：`POST /assets/sign`

- 入参建议：
  - `purpose`：`portfolio-asset`（作品集素材）或 `delivery-photo`（交付照片）
  - `filename`、`contentType`、`size`（用于白名单与限制）
  - 可选：`projectId` / `workId`（用于权限校验与路径规划，不直接入库）
- 出参建议：
  - 直传所需信息（签名/STS/临时凭证、上传目标、过期时间、建议的 `objectKey` 等）

后端需按 `purpose` 做差异化策略：

- **路径前缀**：避免混在同一目录（便于审计与权限策略）
- **类型与大小限制**：例如作品集素材允许视频但交付照片先只允许图片；或反过来按产品策略决定
- **权限校验**：
  - `portfolio-asset`：需要作品集管理权限
  - `delivery-photo`：需要项目交付相关权限，并校验 `projectId` 的可访问性（若提供）

### 4.2 交付照片确认：`POST /photos/confirm`

- 责任：把上传后的文件“绑定到项目/相册”，落库 Photo 元数据，触发异步处理（水印/缩略图/预览图）
- 入参建议：`projectId`、`albumId?`、`objectKey`、`filename`、`size`、`exif?`

### 4.3 作品集素材确认：`POST /works/:id/assets/confirm`

- 责任：把上传后的文件“绑定到作品/作品内容块”，落库素材元数据，更新作品内容
- 入参建议：`workId`、`objectKey`、`type(image/video)`、`sort?`、`coverKey?`

## 5. Admin 路由入口约定（建议）

- **作品集素材**：
  - 作品列表/编辑：`/dashboard/portfolio/works`
  - 轮播图配置：`/dashboard/portfolio/banners`
- **交付照片**：
  - 照片库：`/dashboard/delivery/photos`
  - 可扩展（项目维度）：`/dashboard/delivery/projects/:id/photos`

## 6. 为什么不建议做两套 sign 接口

- 签名/STS 的通用逻辑（鉴权、限流、白名单、日志审计、路径规划）重复建设与测试成本高
- 两套接口容易出现策略漂移（一个口子限制更严、另一个更松），形成安全与运营风险
- 统一 sign + purpose 分流，依然能保证清晰边界：差异化策略集中在一个地方管理
